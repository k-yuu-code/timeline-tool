<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>相談準備用：時系列メモ（モバイル版｜送信しません｜V10 r39）</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="法律相談の準備に使える時系列メモ。入力は端末のブラウザのみに保存され、外部へは送信されません。スマートフォン向け。">
<meta name="referrer" content="no-referrer"><meta http-equiv="Referrer-Policy" content="no-referrer">
<meta name="robots" content="noindex, nofollow, noarchive">
<style>
/* ===== 基本トークン ===== */
#ktl-app{ --bg:#f7f8fb; --b:#111; --m:#666; --bd:#dcdfea; --acc:#0a58cc;
          --th:#eef2fb; --td:#fff; --grid-color:#000; --field:#cfd3e2; }
#ktl-app, #ktl-app *{ box-sizing:border-box; }
html,body{margin:0;padding:0;background:var(--bg);color:var(--b);
  font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP","Yu Gothic",Meiryo,sans-serif;}
.ktl-card{background:#fff;border:1px solid var(--bd);border-radius:12px;padding:12px 14px;margin:10px 0;box-shadow:0 1px 0 rgba(10,10,20,.02);overflow:hidden}
.ktl-muted{color:var(--m)}
.ktl-toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
#ktl-app .ver{font-size:12px;color:#666;margin-left:8px}

/* ラベル（checkbox は除外） */
#ktl-app label{display:block;margin:6px 0 4px;font-weight:600}
#ktl-app label > input:not([type="checkbox"]),
#ktl-app label > select,
#ktl-app label > textarea{ display:block; margin-top:6px; width:100%; }

/* 自動保存（チェックと文言を横並び） */
.ktl-checkRow{ display:flex; align-items:center; gap:8px; margin:2px 0 0; }
.ktl-checkRow input[type="checkbox"]{ width:20px; height:20px; margin:0; }
.ktl-checkRow label{ margin:0; font-weight:700; }

/* 入力コントロール（統一） */
#ktl-app input[type="text"],
#ktl-app input[type="date"],
#ktl-app input[type="time"],
#ktl-app select{
  width:100%; max-width:100%; font-size:16px; line-height:1.3;
  padding:12px; border:1px solid var(--field); border-radius:10px; background:#fff; color:#111;
  min-height:44px; height:44px; -webkit-appearance:none; appearance:none;
}
#ktl-app textarea{
  width:100%; max-width:100%; font-size:16px; line-height:1.5;
  padding:12px; border:1px solid var(--field); border-radius:10px; background:#fff;
  min-height:120px; resize:vertical;
}

/* ★ 関与者／場所／証拠：大きめ（フォーム＆編集ダイアログ） */
#evActor,#evPlace,#evEvidence,
#edActor,#edPlace,#edEvidence{
  font-size:20px; min-height:52px; height:52px;
}

/* 復旧バナー（必要時のみ表示） */
#restoreBanner{ display:none; background:#fff7d1; border-color:#f0d48a; }
#restoreBanner .msg{ font-size:14px; line-height:1.6; }
#restoreBanner .act{ display:flex; gap:8px; align-items:center; justify-content:flex-end; margin-top:6px; }

/* 案件セレクト：カスタム矢印 */
.ktl-caseWrap label{ position:relative; }
.ktl-caseWrap select{
  -webkit-appearance:none !important; appearance:none !important;
  background:#fff !important; padding-right:42px !important;
}
.ktl-caseWrap label::after{
  content:""; position:absolute; right:12px; top:52%; transform:translateY(-50%);
  width:18px; height:18px; pointer-events:none; opacity:.9;
  background:no-repeat center/18px 18px url("data:image/svg+xml;utf8,\
<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23666'><path d='M7 10l5 5 5-5z'/></svg>");
}

/* 種別セレクト：カスタム矢印 */
.ktl-selectWrap{ position:relative; }
.ktl-selectWrap select{ padding-right:42px; -webkit-appearance:none; appearance:none; }
.ktl-selectWrap::after{
  content:""; position:absolute; right:12px; top:52%; transform:translateY(-50%);
  width:18px; height:18px; pointer-events:none; opacity:.9;
  background:no-repeat center/18px 18px url("data:image/svg+xml;utf8,\
<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23666'><path d='M7 10l5 5 5-5z'/></svg>");
}

/* 日付/時刻：線画アイコン */
.ktl-dateWrap,.ktl-timeWrap{ position:relative; }
.ktl-dateWrap input,.ktl-timeWrap input{ padding-right:44px; }
.ktl-dateWrap::after,.ktl-timeWrap::after{
  content:""; position:absolute; right:12px; top:52%; transform:translateY(-50%);
  width:18px; height:18px; pointer-events:none; opacity:.9; background-repeat:no-repeat; background-position:center; background-size:18px 18px;
}
.ktl-dateWrap::after{
  background-image:url("data:image/svg+xml;utf8,\
<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='1.8' stroke-linecap='round' stroke-linejoin='round'><rect x='3' y='5' width='18' height='16' rx='2' ry='2'/><path d='M16 3v4M8 3v4M3 10h18'/></svg>");
}
.ktl-timeWrap::after{
  background-image:url("data:image/svg+xml;utf8,\
<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='1.8' stroke-linecap='round' stroke-linejoin='round'><circle cx='12' cy='12' r='9'/><path d='M12 7v6l4 2'/></svg>");
}

/* ボタン */
.ktl-btn{padding:10px 14px;border:1px solid #333;border-radius:10px;background:#fff;cursor:pointer;font-size:15px;white-space:nowrap}
.ktl-btn-plain{border:1px solid #999}
.ktl-btn-warn{border-color:#b11;color:#b11}
.ktl-btn-primary{border-color:var(--acc);color:var(--acc);font-weight:700}
.ktl-spacer{flex:1}

/* ===== 一覧（画面） ===== */
.ktl-tableWrap{position:relative;padding:0;margin:0;overflow-x:hidden}
table.ktl-list{width:100%;max-width:100%;border-collapse:collapse;table-layout:fixed;background:var(--td);position:relative;z-index:1;margin:0;border:0}
table.ktl-list thead th{text-align:left;padding:6px 6px;font-weight:700;border:0;background:var(--th)}
table.ktl-list tbody td{padding:6px 6px;vertical-align:top;border:0}
table.ktl-list th, table.ktl-list td{
  white-space:normal;word-break:break-word;overflow-wrap:anywhere;hyphens:auto;
  line-height:1.40; font-size:14px; /* ← 少し小さく */
  min-width:0;max-width:100%;
}
/* 特殊列のフォントサイズも統一（はみ出し対策） */
.ktl-list td:nth-child(5), .ktl-list td:nth-child(6),
.ktl-list td:nth-child(8){ font-size:14px; }

/* #列：中央寄せ */
.ktl-list th:nth-child(1), .ktl-list td:nth-child(1){ text-align:center }
.ktl-list tbody td:nth-child(1){ vertical-align:middle }

/* 内容は改行保持／日時は省略表示可 */
table.ktl-list td.ktl-pre{white-space:pre-wrap !important;}
.ktl-nowrap{white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}

/* 罫線オーバーレイ (SVG) */
.ktl-gridlayer{position:absolute;left:0;top:0;width:100%;height:100%;pointer-events:none;z-index:3}
.ktl-gridlayer svg{width:100%;height:100%;display:block;shape-rendering:crispEdges}

/* 操作ボタン（縦書き・見切れ防止の工夫を強化） */
.ktl-list td:last-child{ padding:6px; overflow:hidden; text-align:center; }
.ktl-actions{
  display:flex; flex-direction:column; gap:6px; align-items:center; justify-content:center; min-width:0;
}
.ktl-actions .ktl-btn{
  writing-mode: vertical-rl;
  text-orientation: upright;
  display:inline-flex; align-items:center; justify-content:center;
  min-height:64px; min-width:28px; /* ← 見切れ防止 */
  padding:6px 2px; font-size:10px; line-height:1; letter-spacing:.12em;
  border-radius:10px; white-space:nowrap; overflow:hidden; text-overflow:clip;
  transform:translateZ(0);
}

/* 見出しとPDFボタン */
.ktl-cardHead{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:8px}

/* 2列グリッド */
.ktl-grid{display:grid;grid-template-columns:minmax(0,1fr) minmax(0,1fr);gap:10px}
.ktl-grid .ktl-col2{grid-column:1 / -1}
@media (max-width:480px){ .ktl-grid{grid-template-columns:1fr;} }

/* 案件コントロール */
.ktl-caseRow1{ margin-bottom:6px; }
.ktl-caseRow2{ gap:8px; }
.ktl-caseRow2 .ktl-btn{ flex:1; }

/* カウンタ（内容の直下） */
.ktl-counter{display:block;margin:6px 0 0 2px;font-size:13px;color:#666}

/* PDFメッセージ */
#pdfStatus{margin-top:6px;font-size:13px;color:#333;line-height:1.4}
#pdfStatus a{color:#0a58cc;text-decoration:underline}

/* 印刷レイヤ（iOS対策） */
#PRINT_SHEET{ position:fixed; left:0; top:0; width:100vw; max-width:960px; visibility:hidden; pointer-events:none; z-index:9990; }
</style>
</head>

<body>
<div id="ktl-app" style="max-width:960px;margin:12px auto 60px;padding:0 12px;">

  <!-- 必要時のみ出る復旧バナー -->
  <div id="restoreBanner" class="ktl-card">
    <div class="msg">以前の保存データが見つかりました。復旧を実行しますか？</div>
    <div class="act">
      <button id="doRestore" class="ktl-btn ktl-btn-primary">復旧する</button>
      <button id="dismissRestore" class="ktl-btn ktl-btn-plain">閉じる</button>
    </div>
  </div>

  <div class="ktl-card">
    <h1 style="margin:0 0 6px;font-size:18px">相談準備用・時系列メモ（送信されません）
      <span class="ver">V10 r39</span>
    </h1>
    <p class="ktl-muted" style="line-height:1.6;font-size:14px">
      本ツールは<strong>ご相談準備のための時系列整理</strong>に利用できます。<br>
      入力は<strong>端末のブラウザにのみ保存</strong>され、<strong>外部には送信されません</strong>。
    </p>
    <div class="ktl-toolbar">
      <div class="ktl-checkRow">
        <input type="checkbox" id="autoSave">
        <label for="autoSave">変更のたびに自動保存</label>
      </div>
      <span class="ktl-spacer"></span>
      <button id="wipeAll" class="ktl-btn ktl-btn-warn">全データ削除（この端末）</button>
    </div>
  </div>

  <div class="ktl-card">
    <!-- 案件：select -->
    <div class="ktl-toolbar ktl-caseRow1 ktl-caseWrap">
      <label>案件：
        <select id="caseSelect"></select>
      </label>
    </div>
    <div class="ktl-toolbar ktl-caseRow2">
      <button id="newCase" class="ktl-btn ktl-btn-plain">新規案件</button>
      <button id="renameCase" class="ktl-btn ktl-btn-plain">名前変更</button>
      <button id="dupCase"   class="ktl-btn ktl-btn-plain">複製</button>
      <button id="deleteCase" class="ktl-btn ktl-btn-warn">案件削除</button>
    </div>
  </div>

  <div class="ktl-card">
    <div class="ktl-cardHead">
      <h2 style="margin:0;font-size:16px">時系列一覧</h2>
      <div>
        <button id="pdfBtn" class="ktl-btn ktl-btn-primary">PDF</button>
        <div id="pdfStatus"></div>
      </div>
    </div>
    <div class="ktl-tableWrap" id="tableWrap">
      <div class="ktl-gridlayer" id="gridlayer"><svg></svg></div>
      <table id="listTable" class="ktl-list">
        <colgroup>
          <!-- 列幅合計100%：#5 / 日付15 / 時刻10 / 種別11 / 関与者11 / 場所11 / 内容16 / 証拠9 / 操作12 -->
          <col style="width:5%">
          <col style="width:15%">
          <col style="width:10%">
          <col style="width:11%">
          <col style="width:11%">
          <col style="width:11%">
          <col style="width:16%">
          <col style="width:9%">
          <col style="width:12%">
        </colgroup>
        <thead><tr>
          <th>#</th><th>日付</th><th>時刻</th><th>種別</th><th>関与者</th><th>場所</th>
          <th>内容（事実）</th><th>証拠</th><th>操作</th>
        </tr></thead>
        <tbody id="listBody"><tr><td colspan="9" class="ktl-muted">まだ追加がありません</td></tr></tbody>
      </table>
    </div>
  </div>

  <div class="ktl-card">
    <h2 style="font-size:16px">出来事の追加</h2>
    <div class="ktl-grid">
      <div><label class="ktl-dateWrap">発生日（開始）<input id="evDate" type="date" placeholder="yyyy/mm/dd"></label></div>
      <div><label class="ktl-timeWrap">発生時刻（任意）<input id="evTime" type="time"></label></div>
      <div><label class="ktl-selectWrap">種別
        <select id="evType">
          <option>連絡</option><option>支払い</option><option>通知</option><option>契約</option>
          <option>滞納</option><option>登記</option><option>DV</option><option>その他</option>
        </select>
      </label></div>
      <div><label>関与者（誰が）<input id="evActor" placeholder="例：相手方／自分／子"></label></div>
      <div class="ktl-col2"><label>場所（任意）<input id="evPlace" placeholder="例：自宅／職場／LINE"></label></div>
      <div class="ktl-col2">
        <label>内容（事実ベース・140字まで）<textarea id="evFact" maxlength="140"></textarea></label>
        <small id="counter" class="ktl-counter">0/140</small>
      </div>
      <div class="ktl-col2"><label>裏付け証拠（タイトルのみでも可）<input id="evEvidence" placeholder="例：スクショ（2025-05-10）"></label></div>
      <div class="ktl-col2" style="margin-top:6px; display:flex; gap:8px; align-items:center; justify-content:flex-end;">
        <button id="addBtn" class="ktl-btn ktl-btn-primary">＋ この内容を追加</button>
      </div>
      <div class="ktl-col2" style="margin-top:4px; display:flex; gap:8px; align-items:center; justify-content:flex-end;">
        <button id="saveNow" class="ktl-btn ktl-btn-primary">保存（この端末）</button>
        <span id="unsaved" class="ktl-muted" style="display:none;">● 未保存あり</span>
      </div>
    </div>
    <div id="inlineError" class="ktl-muted" style="color:#b11;margin-top:6px;"></div>
  </div>
</div>

<div id="PRINT_SHEET"></div>

<!-- 編集ダイアログ -->
<dialog id="editDlg">
  <div style="padding:12px 14px;border-bottom:1px solid #eee;font-weight:700">編集</div>
  <div style="padding:14px 14px;min-width:300px">
    <div class="ktl-grid">
      <div><label class="ktl-dateWrap">発生日<input id="edDate" type="date"></label></div>
      <div><label class="ktl-timeWrap">時刻<input id="edTime" type="time"></label></div>
      <div><label class="ktl-selectWrap">種別
        <select id="edType">
          <option>連絡</option><option>支払い</option><option>通知</option><option>契約</option>
          <option>滞納</option><option>登記</option><option>DV</option><option>その他</option>
        </select>
      </label></div>
      <div><label>関与者<input id="edActor" style="font-size:20px; min-height:52px; height:52px;"></label></div>
      <div class="ktl-col2"><label>場所<input id="edPlace" style="font-size:20px; min-height:52px; height:52px;"></label></div>
      <div class="ktl-col2"><label>内容<textarea id="edFact" maxlength="140" style="min-height:120px"></textarea></label></div>
      <div class="ktl-col2"><label>証拠<input id="edEvidence" style="font-size:20px; min-height:52px; height:52px;"></label></div>
    </div>
  </div>
  <div style="padding:10px 14px;border-top:1px solid #eee;display:flex;gap:8px;justify-content:flex-end">
    <button id="editSave" class="ktl-btn ktl-btn-primary">保存</button>
    <button id="editCancel" class="ktl-btn ktl-btn-plain">キャンセル</button>
  </div>
</dialog>

<script>
(function(){
  "use strict";
  const $=id=>document.getElementById(id);

  /* ====== 保存キー & 状態（バックアップ／スナップショット付） ====== */
  const KEY_MAIN   ="KAWAI_TIMELINE_CASESAFE_V1";
  const KEY_BACKUP = KEY_MAIN + "_BACKUP";
  const KEY_SNAP   = KEY_MAIN + "_SNAPSHOTS";
  const SNAP_MAX   = 5;
  const SNAP_MINT  = 60*1000;

  const S={cases:{},order:[],current:"",meta:{v:"r39",updatedAt:Date.now()}};
  let storeOK=false, LAST_SNAP_AT=0, RESTORE_CAND_STR=null;

  const today = () => new Date().toISOString().slice(0,10);
  const nowStr=()=>{const d=new Date(),p=n=>String(n).padStart(2,'0');return d.getFullYear()+p(d.getMonth()+1)+p(d.getDate())+"_"+p(d.getHours())+p(d.getMinutes());};

  /* ストレージ可否 */
  try{ localStorage.setItem("__t","1"); localStorage.removeItem("__t"); storeOK=true; }catch(e){ storeOK=false; }

  /* 保存/復旧ユーティリティ */
  const safeParse=str=>{ try{ return JSON.parse(str); }catch(_){ return null; } };
  const isValidStore=o=>{
    if(!o || typeof o!=="object" || !o.cases || typeof o.cases!=="object") return false;
    if(!Array.isArray(o.order)) o.order=Object.keys(o.cases);
    return true;
  };
  const eventsTotal=o=>{
    try{ let n=0; for(const k of Object.keys(o.cases||{})){ const a=o.cases[k]; if(Array.isArray(a)) n+=a.length; } return n; }catch(_){ return 0; }
  };

  function persist(){
    if(!storeOK) return;
    try{
      S.meta = {v:"r39", updatedAt: Date.now(), total: eventsTotal(S)};
      const str=JSON.stringify(S);
      localStorage.setItem(KEY_MAIN, str);
      localStorage.setItem(KEY_BACKUP, str);
      if(Date.now()-LAST_SNAP_AT >= SNAP_MINT){
        LAST_SNAP_AT=Date.now();
        const snaps = safeParse(localStorage.getItem(KEY_SNAP)) || [];
        if(str.length < 400000){
          snaps.push({t: Date.now(), d: str});
          while(snaps.length > SNAP_MAX) snaps.shift();
          localStorage.setItem(KEY_SNAP, JSON.stringify(snaps));
        }
      }
    }catch(e){}
  }

  function loadFromStr(str){
    const o=safeParse(str); if(!isValidStore(o)) return false;
    S.cases=o.cases; S.order=o.order||Object.keys(o.cases); S.current=(o.current&&o.cases[o.current])?o.current:(S.order[0]||"");
    S.meta=o.meta||{v:"r39",updatedAt:Date.now()};
    normalizeOrder();
    return true;
  }

  function tryLoadAll(){
    if(storeOK){
      const mainStr=localStorage.getItem(KEY_MAIN);
      if(mainStr && loadFromStr(mainStr)) return "main";
      const bkStr=localStorage.getItem(KEY_BACKUP);
      if(bkStr && loadFromStr(bkStr)) return "backup";
      const snaps = safeParse(localStorage.getItem(KEY_SNAP)) || [];
      if(snaps.length){
        const last=snaps[snaps.length-1];
        if(last && last.d && loadFromStr(last.d)) return "snapshot";
        RESTORE_CAND_STR = last && last.d || null;
      }
      // 端末内を走査（簡易）
      let best=null, bestStr=null;
      for(let i=0;i<localStorage.length;i++){
        const k=localStorage.key(i); if(!k) continue;
        if(k===KEY_MAIN || k===KEY_BACKUP || k===KEY_SNAP || k==="__t" || k==="__autosave__") continue;
        const v=localStorage.getItem(k); if(!v) continue;
        const o=safeParse(v); if(!isValidStore(o)) continue;
        const score=(o.meta&&o.meta.updatedAt?o.meta.updatedAt:0)+eventsTotal(o)*1000;
        if(best===null || score>best){ best=score; bestStr=v; }
      }
      if(bestStr && loadFromStr(bestStr)) return "scan";
    }
    return "";
  }

  function normalizeOrder(){
    const names=Object.keys(S.cases);
    const seen=new Set(); const out=[];
    (S.order||[]).forEach(n=>{ if(names.includes(n)&&!seen.has(n)){ seen.add(n); out.push(n);} });
    names.forEach(n=>{ if(!seen.has(n)){ out.push(n); seen.add(n);} });
    S.order=out;
  }

  function ensureDefault(){
    if(!S.order.length){
      const n="案件A_"+today();
      S.cases[n]=[]; S.order=[n]; S.current=n;
    }
  }

  /* ====== UI：案件/一覧 ====== */
  const events=()=> S.cases[S.current]||(S.cases[S.current]=[]);

  function fillCaseSelect(){
    const sel=$("caseSelect"); if(!sel) return;
    sel.innerHTML="";
    S.order.forEach(n=>{
      const op=document.createElement("option"); op.value=n; op.textContent=n;
      if(n===S.current) op.selected=true;
      sel.appendChild(op);
    });
  }
  if($("caseSelect")) $("caseSelect").addEventListener("change", e=>{
    const v=e.target.value; if(S.cases[v]){ S.current=v; persist(); render(); }
  });

  function render(){
    const tbody=$("listBody"); if(!tbody) return;
    tbody.innerHTML="";
    const arr=events().slice().map((ev,idx)=>({ev,idx}))
      .sort((a,b)=>((a.ev.date||"")+(a.ev.time||"")).localeCompare((b.ev.date||"")+(b.ev.time||"")));
    if(!arr.length){
      const tr=document.createElement("tr"); const td=document.createElement("td");
      td.colSpan=9; td.className="ktl-muted"; td.textContent="まだ追加がありません";
      tr.appendChild(td); tbody.appendChild(tr); drawGrid(); return;
    }
    arr.forEach((item,i)=>{
      const e=item.ev; const tr=document.createElement("tr");
      const cell=(t,cls)=>{ const x=document.createElement("td"); if(cls) x.className=cls; x.textContent=t||""; return x; };
      tr.append(
        cell(i+1),
        cell(e.date,"ktl-nowrap"),
        cell(e.time,"ktl-nowrap"),
        cell(e.type),
        cell(e.actor),
        cell(e.place),
        cell(e.fact,"ktl-pre"),
        cell(e.evidence)
      );
      const tdAct=document.createElement("td"); tdAct.className="ktl-actions";
      const bE=document.createElement("button"); bE.textContent="編集"; bE.className="ktl-btn ktl-btn-plain";
      const bD=document.createElement("button"); bD.textContent="削除"; bD.className="ktl-btn ktl-btn-warn";
      bE.onclick=()=>openEdit(item.idx);
      bD.onclick=()=>{ if(confirm("この行を削除します。よろしいですか？")){ events().splice(item.idx,1); saveMaybe(); render(); } };
      tdAct.append(bE,bD); tr.appendChild(tdAct);
      tbody.appendChild(tr);
    });
    drawGrid(); setTimeout(drawGrid,50); setTimeout(drawGrid,300);
  }

  /* ====== 罫線（SVG） ====== */
  function drawGrid(){
    const wrap=$("tableWrap"); if(!wrap) return;
    const table=wrap.querySelector("table"); const svg=wrap.querySelector(".ktl-gridlayer svg"); if(!table||!svg) return;
    svg.innerHTML="";
    const stroke=getComputedStyle(document.documentElement).getPropertyValue('--grid-color')||"#000";
    const sw=1, W=Math.round(table.offsetWidth), H=Math.round(table.offsetHeight);
    svg.setAttribute("viewBox","0 0 "+W+" "+H); svg.setAttribute("preserveAspectRatio","none");
    const th=table.tHead && table.tHead.rows[0]; if(!th) return;
    const rectT=table.getBoundingClientRect();
    const xs=[0]; let acc=0; [...th.cells].forEach(c=>{ acc+=c.offsetWidth; xs.push(acc); });
    const ys=[0]; if(table.tBodies && table.tBodies.length){ for(const tr of table.tBodies[0].rows){ ys.push(Math.round(tr.getBoundingClientRect().bottom-rectT.top)); } }
    const rect=document.createElementNS("http://www.w3.org/2000/svg","rect");
    rect.setAttribute("x",0.5); rect.setAttribute("y",0.5); rect.setAttribute("width",Math.max(0,W-1)); rect.setAttribute("height",Math.max(0,H-1));
    rect.setAttribute("fill","none"); rect.setAttribute("stroke",stroke.trim()||"#000"); rect.setAttribute("stroke-width",sw); rect.setAttribute("vector-effect","non-scaling-stroke"); svg.appendChild(rect);
    xs.forEach((x,i)=>{ if(i===0||i===xs.length-1) return; const cx=Math.round(x)+0.5;
      const ln=document.createElementNS("http://www.w3.org/2000/svg","line");
      ln.setAttribute("x1",cx); ln.setAttribute("y1",0); ln.setAttribute("x2",cx); ln.setAttribute("y2",H);
      ln.setAttribute("stroke",stroke.trim()||"#000"); ln.setAttribute("stroke-width",sw); ln.setAttribute("vector-effect","non-scaling-stroke"); svg.appendChild(ln); });
    ys.forEach((y,i)=>{ if(i===0||i===ys.length-1) return; const cy=Math.round(y)+0.5;
      const ln=document.createElementNS("http://www.w3.org/2000/svg","line");
      ln.setAttribute("x1",0); ln.setAttribute("y1",cy); ln.setAttribute("x2",W); ln.setAttribute("y2",cy);
      ln.setAttribute("stroke",stroke.trim()||"#000"); ln.setAttribute("stroke-width",sw); ln.setAttribute("vector-effect","non-scaling-stroke"); svg.appendChild(ln); });
  }
  window.addEventListener("resize", drawGrid);
  window.addEventListener("orientationchange", drawGrid);

  /* ====== 追加・編集 ====== */
  $("evFact").addEventListener("input",()=>{$("counter").textContent=(($("evFact").value)||"").length+"/140";});
  $("addBtn").onclick=()=>{
    const e={date:$("evDate").value||"", time:$("evTime").value||"", type:$("evType").value||"",
             actor:($("evActor").value||"").trim(), place:($("evPlace").value||"").trim(),
             fact:($("evFact").value)||"", evidence:($("evEvidence").value||"").trim()};
    if(!e.date||!e.fact){ $("inlineError").textContent="日付 と 内容 は必須です"; return; } $("inlineError").textContent="";
    events().push(e); saveMaybe(); render();
  };

  let editingIndex=-1; const dlg=$("editDlg");
  function openEdit(i){ editingIndex=i; const ev=events()[i]; if(!ev) return;
    $("edDate").value=ev.date||""; $("edTime").value=ev.time||""; $("edType").value=ev.type||"その他";
    $("edActor").value=ev.actor||""; $("edPlace").value=ev.place||""; $("edFact").value=ev.fact||""; $("edEvidence").value=ev.evidence||"";
    dlg.showModal();
  }
  window.openEdit=openEdit;
  $("editCancel").onclick=()=>dlg.close();
  $("editSave").onclick=()=>{ const i=editingIndex; if(i<0){ dlg.close(); return; }
    const nv={date:$("edDate").value||"", time:$("edTime").value||"", type:$("edType").value||"",
              actor:($("edActor").value||"").trim(), place:($("edPlace").value||"").trim(),
              fact:($("edFact").value||"").trim(), evidence:($("edEvidence").value||"").trim()};
    if(!nv.date||!nv.fact){ alert("日付 と 内容 は必須です"); return; }
    events()[i]=nv; saveMaybe(); render(); dlg.close();
  };

  /* ====== 保存UI ====== */
  let DIRTY=false;
  const showUnsaved=on=>{const u=$("unsaved"); if(u) u.style.display=on?"inline":"none";};
  const persistAndMark=()=>{ persist(); DIRTY=false; showUnsaved(false); };
  const saveMaybe=()=>{ if($("autoSave").checked){ persistAndMark(); }else{ DIRTY=true; showUnsaved(true); } };
  $("saveNow").onclick=()=>{ persistAndMark(); alert("この端末のブラウザに保存しました。"); };
  window.addEventListener("beforeunload", e=>{ if(!$("autoSave").checked && DIRTY){ e.preventDefault(); e.returnValue=""; } });

  /* ====== PDF（A4固定の複数ページ）— xref を正しく出力する安定版 ====== */
  const PDF_W_PT=595.28, PDF_H_PT=841.89, PDF_MARGIN_PT=24, PX2PT=72/96;

  const measureCtx=(function(){ const c=document.createElement("canvas"); c.width=2; c.height=2; return c.getContext("2d"); })();
  function wrapLine(ctx, text, maxW, font){
    ctx.save(); ctx.font=font; const lines=[]; let line="";
    for(const ch of (text||"")){ const test=line+ch; if(ctx.measureText(test).width<=maxW || line===""){ line=test; } else{ lines.push(line); line=ch; } }
    if(line!=="") lines.push(line); ctx.restore(); return lines.length?lines:[""];
  }
  function wrapText(ctx, text, maxW, font){
    const paras=String(text||"").split(/\r\n|\r|\n/); const out=[];
    paras.forEach((p,pi)=>{ const chunk=wrapLine(ctx,p,maxW,font); out.push(...chunk); if(pi<paras.length-1) out.push(""); });
    return out.length?out:[""];
  }

  function collectForPdf(){
    const arr=(events().slice()||[]);
    arr.sort((a,b)=>((a.date||"")+(a.time||"")).localeCompare((b.date||"")+(b.time||"")));
    return arr.map(e=>({date:e.date||"", time:e.time||"", type:e.type||"", actor:e.actor||"", place:e.place||"", fact:e.fact||"", evidence:e.evidence||""}));
  }

  // 画面の列比率：#5 / 日付15 / 時刻10 / 種別11 / 関与者11 / 場所11 / 内容16 / 証拠9（操作列はPDF除外）
  // 正規化：0.057, 0.170, 0.114, 0.125, 0.125, 0.125, 0.182, 0.102
  function buildPageCanvases(list){
    const pageWpx=Math.ceil(PDF_W_PT/PX2PT), pageHpx=Math.ceil(PDF_H_PT/PX2PT);
    const marginPx=Math.floor(PDF_MARGIN_PT/PX2PT);
    const innerW=pageWpx - marginPx*2;
    const innerH=pageHpx - marginPx*2;

    const cols=[
      {t:"#",w:.057,align:"center",vcenter:true},
      {t:"日付",w:.170},{t:"時刻",w:.114,nowrap:true},{t:"種別",w:.125},
      {t:"関与者",w:.125},{t:"場所",w:.125},{t:"内容（事実）",w:.182},{t:"証拠",w:.102}
    ];
    const colW=cols.map(c=>Math.round(c.w*innerW));

    const headFont="bold 15px -apple-system,BlinkMacSystemFont,'Segoe UI','Noto Sans JP','Yu Gothic',Meiryo,sans-serif";
    const cellFont="13px -apple-system,BlinkMacSystemFont,'Segoe UI','Noto Sans JP','Yu Gothic',Meiryo,sans-serif";
    const lineH=19, padY=12, padX=12, headH=32; // ← 文字小さめに調整

    const rows=list.map((e,i)=>{
      const vals=[String(i+1),e.date,e.time,e.type,e.actor,e.place,e.fact,e.evidence];
      const lines=vals.map((v,ci)=>{ const w=Math.max(12,colW[ci]-padX*2-2); return cols[ci].nowrap ? [v||""] : wrapText(measureCtx,v,w,cellFont); });
      const h=padY*2 + Math.max(...lines.map(ls=>ls.length))*lineH;
      return {vals,lines,h};
    });

    const pages=[]; let idx=0;
    while(idx<rows.length){
      const c=document.createElement("canvas"); c.width=pageWpx; c.height=pageHpx; const ctx=c.getContext("2d");
      ctx.fillStyle="#fff"; ctx.fillRect(0,0,c.width,c.height);
      ctx.strokeStyle="#000"; ctx.lineWidth=1;

      const line={
        rect:(x,y,w,h)=>{ctx.strokeRect(Math.round(x)+0.5,Math.round(y)+0.5,Math.round(w),Math.round(h));},
        v:(x,y1,y2)=>{x=Math.round(x)+0.5;y1=Math.round(y1)+0.5;y2=Math.round(y2)+0.5;ctx.beginPath();ctx.moveTo(x,y1);ctx.lineTo(x,y2);ctx.stroke();},
        h:(y,x1,x2)=>{y=Math.round(y)+0.5;x1=Math.round(x1)+0.5;x2=Math.round(x2)+0.5;ctx.beginPath();ctx.moveTo(x1,y);ctx.lineTo(x2,y);ctx.stroke();}
      };

      let x0=marginPx,y0=marginPx;
      // ヘッダ
      ctx.fillStyle="#dbe8ff"; ctx.fillRect(x0,y0,innerW,headH);
      ctx.fillStyle="#000"; ctx.font=headFont; ctx.textBaseline="middle";
      let cx=x0;
      cols.forEach((cdef,i)=>{ const tx=cdef.t; let txX=cx+padX;
        if(cdef.align==="center"){ const wtx=measureCtx.measureText(tx).width; txX=cx+(colW[i]-wtx)/2; }
        ctx.fillText(tx,Math.max(cx+padX,txX),y0+headH/2); cx+=colW[i];
      });
      line.rect(x0,y0,innerW,headH); cx=x0; cols.forEach((cdef,i)=>{ if(i>0) line.v(cx,y0,y0+headH); cx+=colW[i]; });

      // 明細（ページ割り）
      let y=y0+headH;
      ctx.font=cellFont; ctx.fillStyle="#000"; ctx.textBaseline="alphabetic";
      for(; idx<rows.length; idx++){
        const r=rows[idx];
        if(y + r.h > marginPx + innerH){ break; } // 次ページへ
        line.rect(x0,y,innerW,r.h);
        let cx2=x0; cols.forEach((cdef,i)=>{ if(i>0) line.v(cx2,y,y+r.h); cx2+=colW[i]; });

        let xx=x0;
        r.lines.forEach((ls,i)=>{
          const colWidth=colW[i], left=xx+padX, top=y+padY;
          ctx.save(); ctx.beginPath(); ctx.rect(Math.round(xx)+1, Math.round(y)+1, Math.round(colWidth)-2, Math.round(r.h)-2); ctx.clip();
          if(cols[i].vcenter){
            const tx=r.vals[i]||""; const tw=measureCtx.measureText(tx).width;
            const txX = left + (colWidth-padX*2 - tw)/2; const txY = y + r.h/2 + 0.5;
            ctx.textBaseline="middle"; ctx.fillText(tx, Math.max(left, txX), txY); ctx.textBaseline="alphabetic";
          }else{
            ls.forEach((ln,li)=>{
              let txX=left;
              if(cols[i].align==="center"){
                const tw=measureCtx.measureText(ln).width;
                txX = left + (colWidth-padX*2 - tw)/2;
              }
              ctx.fillText(ln, Math.max(left, txX), top + li*lineH);
            });
          }
          ctx.restore();
          xx+=colWidth;
        });
        y+=r.h;
      }

      // 白紙誤判定防止：右下に1px
      ctx.fillStyle="#000"; ctx.fillRect(c.width-2, c.height-2, 1, 1);

      pages.push({canvas:c});
    }
    return pages;
  }

  function canvasToJpegBytes(canvas){
    let b64, binStr, bin;
    try{ b64=canvas.toDataURL("image/jpeg",0.92); }
    catch(e){ b64=canvas.toDataURL("image/jpeg",0.85); }
    binStr=b64.split(",").pop()||"";
    bin=atob(binStr);
    const u8=new Uint8Array(bin.length);
    for(let i=0;i<bin.length;i++) u8[i]=bin.charCodeAt(i);
    return u8;
  }

  // ★ 複数画像 → 複数ページPDF（xrefを配列で正しく保持）
  function pdfFromImages(imgs, pageW=PDF_W_PT, pageH=PDF_H_PT, margin=PDF_MARGIN_PT){
    const enc=new TextEncoder();
    const parts=[]; let off=0; const xref=[0]; // xref[n] = そのオブジェクトの開始オフセット
    const add=b=>{ parts.push(b); off+=b.length; };
    const addS=s=>add(enc.encode(s));
    const obj=(n,bufs)=>{ xref[n]=off; addS(`${n} 0 obj\n`); Array.isArray(bufs)?bufs.forEach(add):addS(bufs); addS("\nendobj\n"); };

    const W=pageW, H=pageH, M=margin;
    const px2pt=72/96;
    const N=imgs.length;

    const imgObj=(i)=> 3 + i*3;     // 画像XObject
    const cntObj=(i)=> 3 + i*3 + 1; // コンテンツ
    const pagObj=(i)=> 3 + i*3 + 2; // ページ

    addS("%PDF-1.4\n%\xE2\xE3\xCF\xD3\n");

    // 各ページのオブジェクトを順に出力
    for(let i=0;i<N;i++){
      const {bytes,wpx,hpx}=imgs[i];
      const wpt=wpx*px2pt, hpt=hpx*px2pt;
      const maxW=W-M*2, maxH=H-M*2;
      const sc=Math.min(maxW/wpt, maxH/hpt, 1);
      const dw=Math.max(1,wpt*sc), dh=Math.max(1,hpt*sc);
      const x=(W-dw)/2, y=(H-dh)/2;

      // Image XObject
      obj(imgObj(i),[
        enc.encode(`<< /Type /XObject /Subtype /Image /Width ${wpx} /Height ${hpx} /ColorSpace /DeviceRGB /BitsPerComponent 8 /Filter /DCTDecode /Length ${bytes.length} >>\nstream\n`),
        bytes,
        enc.encode("\nendstream\n")
      ]);

      // Content stream
      const content=`q
${dw.toFixed(2)} 0 0 ${dh.toFixed(2)} ${x.toFixed(2)} ${y.toFixed(2)} cm
/Im${i} Do
Q`;
      obj(cntObj(i),`<< /Length ${enc.encode(content).length} >>\nstream\n${content}\nendstream`);

      // Page
      obj(pagObj(i),`<< /Type /Page /Parent 2 0 R /MediaBox [0 0 ${W} ${H}] /Resources << /XObject << /Im${i} ${imgObj(i)} 0 R >> >> /Contents ${cntObj(i)} 0 R >>`);
    }

    // Pages と Catalog
    const kids = Array.from({length:N}, (_,i)=> `${pagObj(i)} 0 R`).join(" ");
    obj(2,`<< /Type /Pages /Count ${N} /Kids [ ${kids} ] >>`);
    obj(1,`<< /Type /Catalog /Pages 2 0 R >>`);

    // xref（最大オブジェクトIDを計算し、欠番は free として埋める）
    const maxId = (N>0) ? pagObj(N-1) : 2;
    const start = off; // startxref は xref 開始位置
    let xS=`xref\n0 ${maxId+1}\n0000000000 65535 f \n`;
    for(let n=1;n<=maxId;n++){
      const pos = (typeof xref[n]==="number") ? xref[n] : 0;
      xS+=`${String(pos).padStart(10,"0")} 00000 ${pos? "n":"f"} \n`;
    }
    xS+=`trailer << /Size ${maxId+1} /Root 1 0 R >>\nstartxref\n${start}\n%%EOF`;
    addS(xS);

    return new Blob(parts,{type:"application/pdf"});
  }

  function makePDF(){
    let list=collectForPdf();
    const draft=($("evFact").value||"").trim();
    if(draft){
      list=list.concat([{date:($("evDate").value||"").trim(),time:($("evTime").value||"").trim(),type:($("evType").value||"").trim(),
        actor:($("evActor").value||"").trim(),place:($("evPlace").value||"").trim(),fact:draft,evidence:($("evEvidence").value||"").trim()}]);
    }
    if(!list.length){ alert("時系列一覧にまだ行がありません。「＋ この内容を追加」で行を追加してください。"); return; }

    let pages;
    try{ pages=buildPageCanvases(list); }
    catch(e){ alert("PDF作成で内部エラーが発生しました。もう一度お試しください。"); return; }

    const imgs=pages.map(p=>({bytes:canvasToJpegBytes(p.canvas), wpx:p.canvas.width, hpx:p.canvas.height}));
    const pdf=pdfFromImages(imgs);
    const url=URL.createObjectURL(pdf); const name="timeline_"+nowStr()+".pdf";
    const a=document.createElement("a"); a.href=url; a.download=name; a.rel="noopener noreferrer"; document.body.appendChild(a); a.click();
    const s=$("pdfStatus"); if(s){ s.innerHTML=`PDFを作成し、ダウンロードを開始しました。保存できない場合は <a href="${url}" download="${name}">ここをタップして保存</a>（60秒以内）。<br><span class="ver">V10 r39</span>`; }
    setTimeout(()=>{ try{ URL.revokeObjectURL(url); }catch(e){} try{ a.remove(); }catch(e){} if(s) s.textContent=""; }, 60000);
  }
  $("pdfBtn").onclick=makePDF;

  /* ====== 初期化 ====== */
  function fillCaseAndRender(){ normalizeOrder(); ensureDefault(); persist(); fillCaseSelect(); render(); }
  (function init(){
    const mode=tryLoadAll(); if(!mode){ ensureDefault(); }
    fillCaseAndRender();
    $("evDate").value=today(); $("counter").textContent="0/140";
    const savedAuto=localStorage.getItem("__autosave__")==="1"; $("autoSave").checked=!!savedAuto;
    $("autoSave").addEventListener("change",()=>localStorage.setItem("__autosave__", $("autoSave").checked?"1":"0"));
    if(!mode && RESTORE_CAND_STR){ const b=$("restoreBanner"); if(b) b.style.display="block"; }
  })();

  /* ====== 復旧/削除 ====== */
  $("doRestore").onclick=()=>{
    if(!RESTORE_CAND_STR) return alert("復旧候補が見つかりませんでした。");
    if(loadFromStr(RESTORE_CAND_STR)){ fillCaseAndRender(); persist(); $("restoreBanner").style.display="none"; alert("保存データを復旧しました。"); }
    else{ alert("復旧に失敗しました。"); }
  };
  $("dismissRestore").onclick=()=>{ $("restoreBanner").style.display="none"; };

  $("wipeAll").onclick=()=>{
    if(!confirm("この端末に保存された全案件・全入力を完全に削除します。よろしいですか？")) return;
    try{ localStorage.removeItem(KEY_MAIN); localStorage.removeItem(KEY_BACKUP); localStorage.removeItem(KEY_SNAP); }catch(e){}
    S.cases={}; S.order=[]; S.current=""; S.meta={v:"r39",updatedAt:Date.now()};
    ensureDefault(); persist(); fillCaseSelect(); render();
    alert("この端末の保存データを削除しました。");
  };

  /* ====== エラー表示（一般的な "Script error." は非表示） ====== */
  const showError=(msg)=>{ const el=$("inlineError"); if(!el) return; el.textContent=msg||""; el.style.display=msg?"block":"none"; };
  window.addEventListener("error", e=>{
    if(!e || e.message==="Script error." || !e.error) return; // 詳細不明は表示しない
    showError("エラー: " + (e.error?.message || e.message));
  });
  window.addEventListener("unhandledrejection", e=>{
    if(!e || !e.reason) return;
    const m = typeof e.reason==="string" ? e.reason : (e.reason.message || "");
    if(m) showError("エラー: " + m);
  });
})();
</script>
</body>
</html>
