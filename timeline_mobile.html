<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>相談準備用：時系列メモ（モバイル版）</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="法律相談の準備に使える時系列メモ。入力は端末のブラウザにのみ保存され、外部へは送信されません。スマートフォン向け。">
<meta name="referrer" content="no-referrer"><meta http-equiv="Referrer-Policy" content="no-referrer">
<meta name="robots" content="noindex, nofollow, noarchive">
<style>
:root{
  --bg:#f7f8fb; --txt:#111; --muted:#666; --bd:#dcdfea; --bd-strong:#9aa4c8;
  --accent:#0a58cc; --th:#eef2fb; --td:#fff; --grid:#000;
  --ctl-h:42px; --radius:10px; --pad:12px; --line:1.4px; --gap:10px;
  /* PDFボタンと一覧（らせん）の確実な間隔 */
  --head-gap:16px;
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:var(--bg);color:var(--txt);
  -webkit-text-size-adjust:100%;
  font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP","Yu Gothic",Meiryo,sans-serif}
body.noscroll{overflow:hidden}
.container{max-width:960px;margin:12px auto 60px;padding:0 12px}
.card{background:#fff;border:1px solid var(--bd);border-radius:12px;padding:12px 14px;margin:10px 0;box-shadow:0 1px 0 rgba(10,10,20,.02)}
.muted{color:var(--muted)}
.ver{font-size:12px;color:#666;margin-left:6px}
h1,h2{margin:0 0 8px}h1{font-size:18px}h2{font-size:16px}

/* ラベル/入力 */
label{display:block;margin:6px 0 4px;font-weight:600}
input[type="text"],input[type="date"],input[type="time"],select{
  width:100%;height:var(--ctl-h);font-size:16px;line-height:1.25;
  padding:0 var(--pad);color:var(--txt);background:#fff;
  border:var(--line) solid var(--bd-strong);border-radius:var(--radius);
  -webkit-appearance:none;appearance:none}
textarea{width:100%;min-height:120px;font-size:16px;line-height:1.45;padding:var(--pad);
  color:var(--txt);border:var(--line) solid var(--bd-strong);border-radius:var(--radius);resize:vertical}

/* 日付/時刻アイコン（線画） */
.wrap-date,.wrap-time{position:relative}
.wrap-date input,.wrap-time input{padding-right:40px}
.wrap-date::after,.wrap-time::after{
  content:"";position:absolute;right:10px;top:50%;transform:translateY(-50%);
  width:16px;height:16px;opacity:.9;pointer-events:none;background-repeat:no-repeat;background-position:center;background-size:16px}
.wrap-date::after{background-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='1.6' stroke-linecap='round' stroke-linejoin='round'><rect x='3' y='5' width='18' height='16' rx='2' ry='2'/><path d='M16 3v4M8 3v4M3 10h18'/></svg>")}
.wrap-time::after{background-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='1.6' stroke-linecap='round' stroke-linejoin='round'><circle cx='12' cy='12' r='9'/><path d='M12 7v6l4 2'/></svg>")}

/* セレクト矢印（案件・種別） */
select.arrow{
  background-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23666'><path d='M7 10l5 5 5-5z'/></svg>");
  background-repeat:no-repeat;background-position:right 10px center;background-size:16px;padding-right:40px}

/* 自動保存：チェックと文言を横並び */
.checkRow{display:flex;align-items:center;gap:8px}
.checkRow input{width:20px;height:20px}

/* 削除ボタン行：距離を離す（区切り線＋余白） */
.memoActions{display:flex;justify-content:flex-end;margin-top:20px;padding-top:12px;border-top:1px dashed #e7eaf4}

/* ボタン */
.btn{height:var(--ctl-h);padding:0 12px;border:1px solid #333;background:#fff;border-radius:var(--radius);font-size:15px;cursor:pointer}
.btn-plain{border-color:#999}.btn-warn{border-color:#b11;color:#b11}.btn-primary{border-color:var(--accent);color:var(--accent);font-weight:700}

/* 案件 */
.caseRow1{display:grid;grid-template-columns:auto 1fr;column-gap:12px;align-items:center}
.caseRow1>label{margin:0;white-space:nowrap}
.caseRow2{display:flex;gap:8px;margin-top:16px;flex-wrap:wrap}

/* 一覧：ヘッダーと表の距離を“確実に”空ける */
.tableWrap{position:relative;overflow-x:hidden;padding-top:var(--head-gap) !important;}
.head{display:flex;align-items:center;justify-content:space-between;gap:8px}
.card > .head{margin-bottom:0 !important;} /* マージン依存を避ける */

/* らせん（SVGレイヤ）を表と同じだけ下げる */
.gridlayer{position:absolute;left:0;top:var(--head-gap) !important;height:calc(100% - var(--head-gap)) !important;width:100%;pointer-events:none}
.gridlayer svg{width:100%;height:100%;display:block;shape-rendering:crispEdges}

table.list{width:100%;border-collapse:collapse;table-layout:fixed;background:var(--td)}
table.list thead th{background:var(--th);padding:6px;font-weight:700}
table.list tbody td{padding:6px;vertical-align:top}
table.list th,table.list td{font-size:10.5px;line-height:1.26;word-break:break-word;overflow-wrap:anywhere}
.list th:nth-child(1),.list td:nth-child(1){text-align:center}
.list td:nth-child(1){vertical-align:middle}
.pre{white-space:pre-wrap!important}
.clamp2{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}

/* 操作列：小型縦ボタン（列幅を圧縮） */
.list td:last-child{padding:3px;text-align:center}
.actions{display:flex;flex-direction:column;gap:4px;align-items:center;justify-content:center}
.actions .btn{
  writing-mode:vertical-rl;text-orientation:upright;
  min-width:12px;min-height:36px;padding:2px 0;
  font-size:7.5px;letter-spacing:.05em;border-radius:9px}

/* 追加フォーム */
.grid{display:grid;grid-template-columns:minmax(0,1fr) minmax(0,1fr);gap:var(--gap)}
.grid .span2{grid-column:1 / -1}

/* 文字数カウンタ */
.counter{display:block;margin:6px 0 0 2px;font-size:13px;color:#666}

/* ===== モーダル（自前） ===== */
.modal{position:fixed;inset:0;display:none;z-index:10000}
.modal.open{display:block}
.modal .backdrop{position:absolute;inset:0;background:rgba(0,0,0,.35)}
.modal .panel{position:absolute;left:50%;top:50%;transform:translate(-50%, -50%);
  width:min(92vw,520px);max-height:90dvh;background:#fff;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.2);
  display:flex;flex-direction:column;overflow:hidden}
.modal .head{padding:10px 12px;border-bottom:1px solid #eee;font-weight:700;font-size:16px}
.modal .body{padding:10px 12px;max-height:calc(90dvh - 96px);overflow:auto}
.modal .foot{padding:10px 12px;border-top:1px solid #eee;display:flex;gap:8px;justify-content:flex-end}

/* 編集フォーム：1カラム固定（モバイル最適） */
#edForm .grid{grid-template-columns:1fr;gap:8px}
#edForm input[type="text"],#edForm input[type="date"],#edForm input[type="time"],#edForm select{
  height:var(--ctl-h);border:var(--line) solid var(--bd-strong);border-radius:var(--radius);padding:0 var(--pad)}
#edForm textarea{min-height:96px;max-height:140px}

@media (max-width:360px){:root{--ctl-h:40px}}
</style>
</head>

<body>
<div class="container" id="app">

  <!-- ▼ 時系列メモ -->
  <div class="card">
    <h1>相談準備用・時系列メモ（送信されません） <span class="ver">V10 r54 mobile-final</span></h1>
    <div class="checkRow">
      <input id="autoSave" type="checkbox"><label for="autoSave">変更のたびに自動保存</label>
    </div>
    <p class="muted" style="line-height:1.6;font-size:14px;margin-top:8px">
      入力は<strong>この端末のブラウザにのみ保存</strong>され、<strong>外部には送信されません</strong>。
    </p>
    <div class="memoActions">
      <button id="wipeAll" class="btn btn-warn" type="button">全データ削除（この端末）</button>
    </div>
  </div>

  <!-- ▼ 案件 -->
  <div class="card">
    <div class="caseRow1">
      <label for="caseSelect">案件：</label>
      <div><select id="caseSelect" class="arrow"></select></div>
    </div>
    <div class="caseRow2">
      <button id="newCase" class="btn btn-plain" type="button">新規案件</button>
      <button id="renameCase" class="btn btn-plain" type="button">名前変更</button>
      <button id="dupCase"   class="btn btn-plain" type="button">複製</button>
      <button id="deleteCase" class="btn btn-warn" type="button">案件削除</button>
    </div>
  </div>

  <!-- ▼ 一覧 -->
  <div class="card">
    <div class="head">
      <h2>時系列一覧</h2>
      <div>
        <button id="pdfBtn" class="btn btn-primary" type="button" aria-busy="false">PDF</button>
        <div id="pdfStatus" class="muted" style="min-height:1.2em;"></div>
      </div>
    </div>
    <div class="tableWrap" id="tableWrap">
      <div class="gridlayer"><svg></svg></div>
      <table class="list" id="listTable">
        <colgroup>
          <!-- 列幅：#5 / 日付18 / 時刻9 / 種別10 / 関与者11 / 場所11 / 内容23 / 証拠7 / 操作6 -->
          <col style="width:5%"><col style="width:18%"><col style="width:9%"><col style="width:10%">
          <col style="width:11%"><col style="width:11%"><col style="width:23%"><col style="width:7%"><col style="width:6%">
        </colgroup>
        <thead><tr>
          <th data-field="index">#</th>
          <th data-field="date">日付</th>
          <th data-field="time">時刻</th>
          <th data-field="type">種別</th>
          <th data-field="actor">関与者</th>
          <th data-field="place">場所</th>
          <th data-field="fact">内容（事実）</th>
          <th data-field="evidence">証拠</th>
          <th data-field="actions" data-pdf="0">操作</th>
        </tr></thead>
        <tbody id="listBody"><tr><td colspan="9" class="muted">まだ追加がありません</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- ▼ 追加フォーム -->
  <div class="card">
    <h2>出来事の追加</h2>
    <div class="grid">
      <div><label class="wrap-date">発生日（開始）<input id="evDate" type="date" placeholder="yyyy/mm/dd"></label></div>
      <div><label class="wrap-time">発生時刻（任意）<input id="evTime" type="time"></label></div>
      <div><label>種別
        <select id="evType" class="arrow">
          <option>連絡</option><option>支払い</option><option>通知</option><option>契約</option>
          <option>滞納</option><option>登記</option><option>DV</option><option>その他</option>
        </select>
      </label></div>
      <div><label>関与者（誰が）<input id="evActor" type="text" placeholder="例：相手方／自分／子"></label></div>
      <div class="span2"><label>場所（任意）<input id="evPlace" type="text" placeholder="例：自宅／職場／LINE"></label></div>
      <div class="span2">
        <label>内容（事実ベース・140字まで）<textarea id="evFact" maxlength="140"></textarea></label>
        <small id="counter" class="counter">0/140</small>
      </div>
      <div class="span2"><label>裏付け証拠（タイトルのみでも可）<input id="evEvidence" type="text" placeholder="例：スクショ（2025-05-10）"></label></div>
      <div class="span2" style="display:flex;gap:8px;justify-content:flex-end">
        <button id="addBtn" class="btn btn-primary" type="button">＋ この内容を追加</button>
      </div>
      <div class="span2" style="display:flex;gap:8px;justify-content:flex-end">
        <button id="saveNow" class="btn btn-primary" type="button">保存（この端末）</button>
        <span id="unsaved" class="muted" style="display:none;">● 未保存あり</span>
      </div>
    </div>
    <div id="inlineError" class="muted" style="color:#b11;margin-top:6px;"></div>
  </div>
</div>

<!-- ▼ 編集モーダル（自前） -->
<div id="editModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="editTitle">
  <div class="backdrop"></div>
  <div class="panel" id="edPanel">
    <div class="head" id="editTitle">編集</div>
    <div class="body">
      <form id="edForm" onsubmit="return false;">
        <div class="grid">
          <div><label class="wrap-date">発生日<input id="edDate" type="date"></label></div>
          <div><label class="wrap-time">時刻<input id="edTime" type="time"></label></div>
          <div><label>種別
            <select id="edType" class="arrow">
              <option>連絡</option><option>支払い</option><option>通知</option><option>契約</option>
              <option>滞納</option><option>登記</option><option>DV</option><option>その他</option>
            </select>
          </label></div>
          <div><label>関与者<input id="edActor" type="text"></label></div>
          <div><label>場所<input id="edPlace" type="text"></label></div>
          <div><label>証拠<input id="edEvidence" type="text"></label></div>
          <div class="span2"><label>内容<textarea id="edFact" maxlength="140"></textarea></label></div>
        </div>
      </form>
    </div>
    <div class="foot">
      <button id="editSave"   class="btn btn-primary" type="button">保存</button>
      <button id="editCancel" class="btn btn-plain" type="button">キャンセル</button>
    </div>
  </div>
</div>

<!-- 印刷レイヤ（PDF生成内部） -->
<div id="PRINT_SHEET" style="visibility:hidden;pointer-events:none;"></div>

<script>
(function(){
  "use strict";
  const $=id=>document.getElementById(id);

  /* ===== ストア ===== */
  const KEY_MAIN="KAWAI_TIMELINE_CASESAFE_V1", KEY_BACKUP=KEY_MAIN+"_BACKUP", KEY_SNAP=KEY_MAIN+"_SNAPSHOTS";
  const SNAP_MAX=5, SNAP_MINT=60*1000;
  let storeOK=false; try{ localStorage.setItem("__t","1"); localStorage.removeItem("__t"); storeOK=true; }catch(e){}
  const S={cases:{},order:[],current:"",meta:{v:"r54",updatedAt:Date.now()}};
  const today=()=>new Date().toISOString().slice(0,10);
  const nowStr=()=>{const d=new Date(),p=n=>String(n).padStart(2,'0');return d.getFullYear()+p(d.getMonth()+1)+p(d.getDate())+"_"+p(d.getHours())+p(d.getMinutes());};
  const parse=s=>{try{return JSON.parse(s);}catch(_){return null;}};
  const valid=o=>o&&typeof o==="object"&&o.cases&&typeof o.cases==="object";
  const total=o=>{try{let n=0;for(const k of Object.keys(o.cases||{})){const a=o.cases[k];if(Array.isArray(a))n+=a.length;}return n;}catch(_){return 0;}};

  function persist(){
    if(!storeOK) return;
    try{
      S.meta={v:"r54",updatedAt:Date.now(),total:total(S)};
      const str=JSON.stringify(S);
      localStorage.setItem(KEY_MAIN,str);
      localStorage.setItem(KEY_BACKUP,str);
      const now=Date.now(), lastT=Number(localStorage.getItem(KEY_SNAP+"_t"))||0;
      if(now-lastT>=SNAP_MINT && str.length<400000){
        const snaps=parse(localStorage.getItem(KEY_SNAP))||[];
        snaps.push({t:now,d:str}); while(snaps.length>SNAP_MAX) snaps.shift();
        localStorage.setItem(KEY_SNAP,JSON.stringify(snaps)); localStorage.setItem(KEY_SNAP+"_t",String(now));
      }
    }catch(e){}
  }
  function loadAll(){
    const m=parse(localStorage.getItem(KEY_MAIN)); if(valid(m)){Object.assign(S,m); norm(); return true;}
    const b=parse(localStorage.getItem(KEY_BACKUP)); if(valid(b)){Object.assign(S,b); norm(); return true;}
    const sn=parse(localStorage.getItem(KEY_SNAP))||[]; if(sn.length){const last=parse(sn[sn.length-1].d); if(valid(last)){Object.assign(S,last); norm(); return true;}}
    return false;
  }
  function norm(){
    const names=Object.keys(S.cases||{}); const out=[]; const seen=new Set();
    (S.order||[]).forEach(n=>{ if(names.includes(n)&&!seen.has(n)){ out.push(n); seen.add(n);} });
    names.forEach(n=>{ if(!seen.has(n)) out.push(n); });
    S.order=out; if(!S.current||!S.cases[S.current]) S.current=out[0]||"";
  }
  function ensureDefault(){ if(!S.order.length){ const n="案件A_"+today(); S.cases[n]=[]; S.order=[n]; S.current=n; } }
  const evts=()=>S.cases[S.current]||(S.cases[S.current]=[]);

  /* ===== 案件UI ===== */
  function fillCases(){
    const sel=$("caseSelect"); sel.innerHTML="";
    S.order.forEach(n=>{ const op=document.createElement("option"); op.value=n; op.textContent=n; if(n===S.current) op.selected=true; sel.appendChild(op); });
  }
  $("caseSelect").addEventListener("change",e=>{ const v=e.target.value; if(S.cases[v]){ S.current=v; persist(); render(); } });

  const uniq=base=>{ let n=base||"案件",i=2; while(S.cases[n]) n=base+" ("+(i++)+")"; return n; };
  const nextName=()=> "案件"+((S.order?.length||0)+1)+"_"+today();
  $("newCase").addEventListener("click",()=>{
    const input=prompt("新しい案件名を入力してください", nextName()); if(input===null) return;
    const name=uniq((input||"").trim()); if(!name) return;
    S.cases[name]=[]; if(!S.order.includes(name)) S.order.push(name); S.current=name;
    persist(); fillCases(); render(); alert("案件を作成しました："+name);
  });
  $("renameCase").addEventListener("click",()=>{
    const old=S.current; if(!old){ alert("案件が選択されていません。"); return; }
    const input=prompt("案件名を変更します", old); if(input===null) return;
    const name=(input||"").trim(); if(!name||name===old) return;
    if(S.cases[name] && name!==old){ alert("同名の案件が既にあります。"); return; }
    S.cases[name]=S.cases[old]; delete S.cases[old]; S.order=S.order.map(n=>n===old?name:n); S.current=name;
    persist(); fillCases(); render();
  });
  $("dupCase").addEventListener("click",()=>{
    const src=S.current; if(!src){ alert("案件が選択されていません。"); return; }
    const name=uniq(src+"（複製）"); S.cases[name]=JSON.parse(JSON.stringify(S.cases[src]||[]));
    if(!S.order.includes(name)) S.order.push(name); S.current=name;
    persist(); fillCases(); render(); alert("案件を複製しました："+name);
  });
  $("deleteCase").addEventListener("click",()=>{
    const cur=S.current; if(!cur){ alert("案件が選択されていません。"); return; }
    const cnt=(S.cases[cur]||[]).length;
    if(!confirm("案件「"+cur+"」を削除します（行数："+cnt+"）。よろしいですか？")) return;
    delete S.cases[cur]; S.order=S.order.filter(n=>n!==cur); S.current=S.order[0]||"";
    if(!S.current){ const n="案件A_"+today(); S.cases[n]=[]; S.order=[n]; S.current=n; }
    persist(); fillCases(); render();
  });

  /* ===== 一覧描画 ===== */
  function td(txt,cls){ const x=document.createElement("td"); if(cls) x.className=cls; x.textContent=txt||""; return x; }
  function tdDate(txt){ const td=document.createElement("td"); const sp=document.createElement("span"); sp.className="clamp2"; sp.textContent=txt||""; td.appendChild(sp); return td; }

  function render(){
    const tbody=$("listBody"); tbody.innerHTML="";
    const list=evts().map((e,i)=>({e,i})).sort((a,b)=>((a.e.date||"")+(a.e.time||"")).localeCompare((b.e.date||"")+(b.e.time||"")));
    if(!list.length){ const tr=document.createElement("tr"); const td=document.createElement("td"); td.colSpan=9; td.className="muted"; td.textContent="まだ追加がありません"; tr.appendChild(td); tbody.appendChild(tr); drawGrid(); return; }
    list.forEach((it,idx)=>{
      const e=it.e; const tr=document.createElement("tr");
      tr.appendChild(td(idx+1));
      tr.appendChild(tdDate(e.date));
      tr.appendChild(td(e.time));
      tr.appendChild(td(e.type));
      tr.appendChild(td(e.actor));
      tr.appendChild(td(e.place));
      tr.appendChild(td(e.fact,"pre"));
      tr.appendChild(td(e.evidence));
      const act=document.createElement("td"); act.className="actions";
      const bE=document.createElement("button"); bE.className="btn btn-plain"; bE.textContent="編集"; bE.type="button";
      const bD=document.createElement("button"); bD.className="btn btn-warn";  bD.textContent="削除"; bD.type="button";
      bE.onclick=()=>openEdit(it.i);
      bD.onclick=()=>{ if(confirm("この行を削除します。よろしいですか？")){ evts().splice(it.i,1); saveMaybe(); render(); } };
      act.append(bE,bD); tr.appendChild(act);
      tbody.appendChild(tr);
    });
    drawGrid(); setTimeout(drawGrid,50); setTimeout(drawGrid,300);
  }

  /* ===== 罫線SVG（らせん） ===== */
  function drawGrid(){
    const wrap=$("tableWrap"); const table=$("listTable"); const svg=wrap.querySelector("svg"); if(!table||!svg) return;
    svg.innerHTML="";
    const stroke=getComputedStyle(document.documentElement).getPropertyValue('--grid')||"#000";
    const sw=1, W=Math.round(table.offsetWidth), H=Math.round(table.offsetHeight);
    svg.setAttribute("viewBox","0 0 "+W+" "+H); svg.setAttribute("preserveAspectRatio","none");
    const th=table.tHead && table.tHead.rows[0]; if(!th) return;
    const rectT=table.getBoundingClientRect();
    const xs=[0]; let acc=0; [...th.cells].forEach(c=>{ acc+=c.offsetWidth; xs.push(acc); });
    const ys=[0]; if(table.tBodies && table.tBodies.length){ for(const tr of table.tBodies[0].rows){ ys.push(Math.round(tr.getBoundingClientRect().bottom-rectT.top)); } }
    const rect=(x,y,w,h)=>{ const r=document.createElementNS("http://www.w3.org/2000/svg","rect");
      r.setAttribute("x",x+0.5); r.setAttribute("y",y+0.5); r.setAttribute("width",Math.max(0,w-1)); r.setAttribute("height",Math.max(0,h-1));
      r.setAttribute("fill","none"); r.setAttribute("stroke",stroke.trim()); r.setAttribute("stroke-width",sw); r.setAttribute("vector-effect","non-scaling-stroke"); svg.appendChild(r); };
    const v=(x,y1,y2)=>{ const l=document.createElementNS("http://www.w3.org/2000/svg","line");
      l.setAttribute("x1",Math.floor(x)+0.5); l.setAttribute("y1",Math.floor(y1)+0.5); l.setAttribute("x2",Math.floor(x)+0.5); l.setAttribute("y2",Math.floor(y2)+0.5);
      l.setAttribute("stroke",stroke.trim()); l.setAttribute("stroke-width",sw); l.setAttribute("vector-effect","non-scaling-stroke"); svg.appendChild(l); };
    const h=(y,x1,x2)=>{ const l=document.createElementNS("http://www.w3.org/2000/svg","line");
      l.setAttribute("x1",Math.floor(x1)+0.5); l.setAttribute("y1",Math.floor(y)+0.5); l.setAttribute("x2",Math.floor(x2)+0.5); l.setAttribute("y2",Math.floor(y)+0.5);
      l.setAttribute("stroke",stroke.trim()); l.setAttribute("stroke-width",sw); l.setAttribute("vector-effect","non-scaling-stroke"); svg.appendChild(l); };
    rect(0,0,W,H); xs.forEach((x,i)=>{ if(i===0||i===xs.length-1) return; v(x,0,H); }); ys.forEach((y,i)=>{ if(i===0||i===ys.length-1) return; h(y,0,W); });
  }
  addEventListener("resize",drawGrid); addEventListener("orientationchange",drawGrid);

  /* ===== 追加 & カウンタ ===== */
  $("evFact").addEventListener("input",()=>{ $("counter").textContent=(($("evFact").value)||"").length+"/140"; });
  $("addBtn").addEventListener("click",()=>{
    const e={ date:$("evDate").value||"", time:$("evTime").value||"", type:$("evType").value||"",
              actor:($("evActor").value||"").trim(), place:($("evPlace").value||"").trim(),
              fact:($("evFact").value||""), evidence:($("evEvidence").value||"").trim() };
    if(!e.date||!e.fact){ $("inlineError").textContent="日付 と 内容 は必須です"; return; }
    $("inlineError").textContent=""; evts().push(e); saveMaybe(); render();
  });

  /* ===== 編集モーダル ===== */
  let editing=-1; const modal=$("editModal");
  function openEdit(i){
    editing=i; const e=evts()[i]; if(!e) return;
    $("edDate").value=e.date||""; $("edTime").value=e.time||""; $("edType").value=e.type||"その他";
    $("edActor").value=e.actor||""; $("edPlace").value=e.place||""; $("edEvidence").value=e.evidence||""; $("edFact").value=e.fact||"";
    modal.classList.add("open"); document.body.classList.add("noscroll");
    setTimeout(()=>{ try{$("edDate").focus();}catch(_){ } }, 0);
  }
  window.openEdit=openEdit;
  const closeEdit=()=>{ modal.classList.remove("open"); document.body.classList.remove("noscroll"); };
  $("editCancel").addEventListener("click",closeEdit);
  modal.querySelector(".backdrop").addEventListener("click",closeEdit);
  document.addEventListener("keydown",e=>{ if(e.key==="Escape" && modal.classList.contains("open")) closeEdit(); });

  $("editSave").addEventListener("click",()=>{
    const i=editing; if(i<0){ closeEdit(); return; }
    const nv={ date:$("edDate").value||"", time:$("edTime").value||"", type:$("edType").value||"",
               actor:($("edActor").value||"").trim(), place:($("edPlace").value||"").trim(),
               fact:($("edFact").value||"").trim(), evidence:($("edEvidence").value||"").trim() };
    if(!nv.date||!nv.fact){ alert("日付 と 内容 は必須です"); return; }
    evts()[i]=nv; saveMaybe(); render(); closeEdit();
  });

  /* ===== 保存UI ===== */
  let DIRTY=false;
  const mark=()=>{ DIRTY=false; $("unsaved").style.display="none"; };
  const saveMaybe=()=>{ if($("autoSave").checked){ persist(); mark(); } else { DIRTY=true; $("unsaved").style.display="inline"; } };
  $("saveNow").addEventListener("click",()=>{ persist(); mark(); alert("この端末のブラウザに保存しました。"); });
  addEventListener("beforeunload",e=>{ if(!$("autoSave").checked && DIRTY){ e.preventDefault(); e.returnValue=""; } });

  /* ===== PDF（堅牢化：進捗表示・多重クリック防止・デリゲート） ===== */
  const PDF_W_PT=595.28, PDF_H_PT=841.89, PDF_MARGIN_PT=24, PX2PT=72/96;
  const mctx=(()=>{ const c=document.createElement("canvas"); c.width=2; c.height=2; return c.getContext("2d"); })();

  const setPdfStatus=(msg,err)=>{ const s=$("pdfStatus"); if(!s) return; s.style.color=err?'#b11':'#333'; s.textContent=msg||""; };
  const setPdfBusy=(busy)=>{ const b=$("pdfBtn"); if(!b) return; b.disabled=!!busy; b.setAttribute('aria-busy',busy?'true':'false'); };

  const wrapLine=(ctx,t,maxW,font)=>{ ctx.save(); ctx.font=font; const out=[]; let line=""; for(const ch of String(t||"")){ const test=line+ch; if(ctx.measureText(test).width<=maxW || line===""){ line=test; } else { out.push(line); line=ch; } } if(line!=="") out.push(line); ctx.restore(); return out.length?out:[""]; };
  const wrapText=(ctx,t,maxW,font)=>{ const ps=String(t||"").split(/\r\n|\r|\n/); const out=[]; ps.forEach((p,i)=>{ out.push(...wrapLine(ctx,p,maxW,font)); if(i<ps.length-1) out.push(""); }); return out.length?out:[""]; };

  function pdfCols(){
    const ths=[...document.querySelectorAll('#listTable thead th')];
    const ok=ths.filter(th=> th.getAttribute('data-pdf')!=='0' && th.offsetWidth>0);
    const sum=ok.reduce((s,th)=>s+th.offsetWidth,0)||1;
    return ok.map(th=>{ const key=th.dataset.field||th.textContent.trim(); const cfg={key, t:th.textContent.trim(), w:th.offsetWidth/sum, align:null, nowrap:false, vcenter:false}; if(key==='index'){cfg.align='center'; cfg.vcenter=true;} if(['date','time','type'].includes(key)) cfg.align='center'; if(key==='time') cfg.nowrap=true; return cfg; });
  }
  function rowsForPdf(cols){
    const tb=document.querySelector('#listTable tbody'); if(!tb) return [];
    const thAll=[...document.querySelectorAll('#listTable thead th')];
    const idxs=cols.map(c=>{ const th=thAll.find(h=>(h.dataset.field||h.textContent.trim())===c.key); return th? th.cellIndex : -1; });
    const rows=[]; [...tb.rows].forEach(tr=>{ if(tr.cells.length===1 && tr.cells[0].classList.contains('muted')) return; const o={}; idxs.forEach((i,ci)=>{ if(i<0) return; const td=tr.cells[i]; const txt=(td? (td.innerText||td.textContent) : "").replace(/\s+\n/g,"\n").trim(); o[cols[ci].key]=txt; }); rows.push(o); }); return rows;
  }
  function pagesFrom(list, cols){
    const pageWpx=Math.ceil(PDF_W_PT/PX2PT), pageHpx=Math.ceil(PDF_H_PT/PX2PT);
    const SCALE=2, marginPx=Math.floor(PDF_MARGIN_PT/PX2PT), innerW=pageWpx-marginPx*2, innerH=pageHpx-marginPx*2;
    let cw=cols.map(c=>Math.round(c.w*innerW)); const diff=innerW-cw.reduce((a,b)=>a+b,0); cw[cw.length-1]+=diff;
    const headFont="bold 15px -apple-system,BlinkMacSystemFont,'Segoe UI','Noto Sans JP','Yu Gothic',Meiryo,sans-serif";
    const cellFont="13px -apple-system,BlinkMacSystemFont,'Segoe UI','Noto Sans JP','Yu Gothic',Meiryo,sans-serif";
    const lineH=19, padY=8, padX=12, headH=32;
    const rows=list.map((e,i)=>{ const vals=cols.map(c=> c.key==='index'? String(i+1):(e[c.key]||"")); const lines=vals.map((v,ci)=>{ const avail=Math.max(12,cw[ci]-padX*2-2); return cols[ci].nowrap?[v||""]:wrapText(mctx,v,avail,cellFont); }); const blockHs=lines.map(ls=>Math.max(lineH,ls.length*lineH)); const h=Math.max(lineH+padY*2, Math.max(...blockHs)+padY*2); return {vals,lines,blockHs,h}; });
    const pages=[]; let idx=0;
    while(idx<rows.length){
      const c=document.createElement("canvas"); c.width=Math.floor(pageWpx*SCALE); c.height=Math.floor(PDF_H_PT/PX2PT*SCALE);
      const ctx=c.getContext("2d"); ctx.scale(SCALE,SCALE); ctx.imageSmoothingEnabled=false; ctx.fillStyle="#fff"; ctx.fillRect(0,0,c.width,c.height); ctx.strokeStyle="#000"; ctx.lineWidth=1;
      const L={rect:(x,y,w,h)=>ctx.strokeRect(Math.floor(x)+0.5,Math.floor(y)+0.5,Math.floor(w),Math.floor(h)),v:(x,y1,y2)=>{x=Math.floor(x)+0.5;y1=Math.floor(y1)+0.5;y2=Math.floor(y2)+0.5;ctx.beginPath();ctx.moveTo(x,y1);ctx.lineTo(x,y2);ctx.stroke();}};
      let x0=marginPx, y0=marginPx;
      ctx.fillStyle="#dbe8ff"; ctx.fillRect(x0,y0,innerW,headH);
      ctx.fillStyle="#000"; ctx.font=headFont; ctx.textBaseline="middle";
      let cx=x0; cols.forEach((cdef,i)=>{ const tx=cdef.t, wtx=mctx.measureText(tx).width; let txX=cx+padX; if(cdef.align==="center") txX=cx+(cw[i]-wtx)/2; ctx.fillText(tx,Math.max(cx+padX,txX),y0+headH/2); cx+=cw[i]; });
      L.rect(x0,y0,innerW,headH); cx=x0; cols.forEach((_,i)=>{ if(i>0) L.v(cx,y0,y0+headH); cx+=cw[i]; });
      let y=y0+headH; ctx.font=cellFont; ctx.textBaseline="top";
      for(; idx<rows.length; idx++){
        const r=rows[idx]; if(y+r.h>marginPx+innerH) break;
        L.rect(x0,y,innerW,r.h); let cx2=x0; cols.forEach((_,i)=>{ if(i>0) L.v(cx2,y,y+r.h); cx2+=cw[i]; });
        let xx=x0;
        r.lines.forEach((ls,i)=>{
          const colW=cw[i], blockH=r.blockHs[i], top=y+Math.max(padY,Math.floor((r.h-blockH)/2));
          ctx.save(); ctx.beginPath(); ctx.rect(Math.floor(xx)+1,Math.floor(y)+1,Math.floor(colW)-2,Math.floor(r.h)-2); ctx.clip();
          if(cols[i].vcenter){ ctx.textBaseline="middle"; const tx=r.vals[i]||""; const tw=mctx.measureText(tx).width; const txX=xx+(colW-tw)/2; const txY=y+r.h/2+0.5; ctx.fillText(tx,txX,txY); ctx.textBaseline="top"; }
          else{ ls.forEach((ln,li)=>{ let txX=xx+padX; if(cols[i].align==="center"){ const tw=mctx.measureText(ln).width; txX=xx+(colW-tw)/2; } ctx.fillText(ln,txX,top+li*lineH); }); }
          ctx.restore(); xx+=colW;
        });
        y+=r.h;
      }
      ctx.fillStyle="#000"; ctx.fillRect(c.width-4,c.height-4,1,1);
      pages.push({canvas:c});
    }
    return pages;
  }

  const jpegBytes=(canvas)=>{ let b64; try{ b64=canvas.toDataURL("image/jpeg",0.92); }catch(e){ b64=canvas.toDataURL("image/jpeg",0.88); } const b=atob(b64.split(",").pop()||""); const u8=new Uint8Array(b.length); for(let i=0;i<b.length;i++) u8[i]=b.charCodeAt(i); return u8; };

  function pdfFrom(imgs,W=595.28,H=841.89,M=24){
    const enc=new TextEncoder(); const parts=[]; let off=0; const xref=[0];
    const add=b=>{parts.push(b); off+=b.length;}, addS=s=>add(enc.encode(s));
    const obj=(n,buf)=>{ xref[n]=off; addS(`${n} 0 obj\n`); if(Array.isArray(buf)){ buf.forEach(add); } else { addS(buf); } addS("\nendobj\n"); };
    addS("%PDF-1.4\n%\xE2\xE3\xCF\xD3\n");
    const N=imgs.length, img=i=>3+i*3, cnt=i=>4+i*3, page=i=>5+i*3;
    for(let i=0;i<N;i++){
      const it=imgs[i], px2pt=72/96, wpt=it.wpx*px2pt/2, hpt=it.hpx*px2pt/2;
      const sc=Math.min((W-M*2)/wpt,(H-M*2)/hpt,1), dw=(wpt*sc).toFixed(2), dh=(hpt*sc).toFixed(2), x=((W-wpt*sc)/2).toFixed(2), y=((H-hpt*sc)/2).toFixed(2);
      obj(img(i),[
        enc.encode(`<< /Type /XObject /Subtype /Image /Width ${it.wpx} /Height ${it.hpx} /ColorSpace /DeviceRGB /BitsPerComponent 8 /Filter /DCTDecode /Length ${it.bytes.length} >>\nstream\n`),
        it.bytes,
        enc.encode("\nendstream\n")
      ]);
      const c=`q
${dw} 0 0 ${dh} ${x} ${y} cm
/Im${i} Do
Q`;
      obj(cnt(i),`<< /Length ${enc.encode(c).length} >>\nstream\n${c}\nendstream`);
      obj(page(i),`<< /Type /Page /Parent 2 0 R /MediaBox [0 0 ${W} ${H}] /Resources << /XObject << /Im${i} ${img(i)} 0 R >> >> /Contents ${cnt(i)} 0 R >>`);
    }
    const kids=Array.from({length:N},(_,i)=>`${page(i)} 0 R`).join(" ");
    obj(2,`<< /Type /Pages /Count ${N} /Kids [ ${kids} ] >>`);
    obj(1,`<< /Type /Catalog /Pages 2 0 R >>`);
    const max=(N>0)?page(N-1):2; const start=off;
    let x="xref\n0 "+(max+1)+"\n0000000000 65535 f \n";
    for(let i=1;i<=max;i++){ const p=(typeof xref[i]==="number")?xref[i]:0; x+=String(p).padStart(10,"0")+" 00000 "+(p?"n":"f")+" \n"; }
    x+=`trailer << /Size ${max+1} /Root 1 0 R >>\nstartxref\n${start}\n%%EOF`;
    addS(x);
    return new Blob(parts,{type:"application/pdf"});
  }

  function makePDF(){
    try{
      setPdfBusy(true); setPdfStatus("PDFを作成中…", false);
      const cols=pdfCols(); const list=rowsForPdf(cols);
      if(!list.length){ setPdfStatus("",false); setPdfBusy(false); alert("PDFに出力できる行がありません。"); return false; }
      let pages;
      try{ pages=pagesFrom(list,cols); }catch(e){ throw new Error("PDFページ生成でエラー: "+(e.message||e)); }
      const imgs=pages.map(p=>({bytes:jpegBytes(p.canvas), wpx:p.canvas.width, hpx:p.canvas.height}));
      const pdf=pdfFrom(imgs);
      const url=URL.createObjectURL(pdf);
      const name="timeline_"+nowStr()+".pdf";
      // 自動ダウンロード + 手動保存リンク（60秒有効）
      const a=document.createElement("a"); a.href=url; a.download=name; a.rel="noopener"; document.body.appendChild(a); a.click();
      const s=$("pdfStatus");
      if(s){ s.innerHTML="PDFを作成し、ダウンロードを開始しました。"; const link=document.createElement("a"); link.href=url; link.download=name; link.textContent="こちらをタップして保存"; link.style.marginLeft="6px"; s.appendChild(link); s.appendChild(document.createTextNode("（60秒以内）")); }
      setTimeout(()=>{ try{URL.revokeObjectURL(url);}catch(_){ } try{a.remove();}catch(_){ } setPdfStatus("",false); },60000);
      return false;
    }catch(err){
      console.error(err);
      setPdfStatus("PDF作成でエラー: " + (err && err.message ? err.message : err), true);
      alert("PDF作成でエラーが発生しました。\n" + (err && err.message ? err.message : err));
      return false;
    }finally{
      setPdfBusy(false);
    }
  }
  window.makePDF = makePDF;

  // クリック捕捉を三段構えで（テーマ差分・タッチ端末でも確実に）
  if ($("pdfBtn")) $("pdfBtn").addEventListener("click", (e)=>{ e.preventDefault(); e.stopPropagation(); makePDF(); }, {passive:false});
  document.addEventListener("click", (e)=>{
    const btn = e.target && (e.target.id==="pdfBtn" ? e.target : e.target.closest && e.target.closest("#pdfBtn"));
    if(btn){ e.preventDefault(); makePDF(); }
  }, {capture:true});
  document.addEventListener("touchend", (e)=>{
    const btn = e.target && (e.target.id==="pdfBtn" ? e.target : e.target.closest && e.target.closest("#pdfBtn"));
    if(btn){ e.preventDefault(); makePDF(); }
  }, {passive:false});

  /* ===== 初期化 ===== */
  (function init(){
    if(!loadAll()) ensureDefault();
    persist(); fillCases(); render();
    $("evDate").value=today(); $("counter").textContent="0/140";
    const savedAuto=localStorage.getItem("__autosave__")==="1"; $("autoSave").checked=!!savedAuto;
    $("autoSave").addEventListener("change",()=>localStorage.setItem("__autosave__", $("autoSave").checked?"1":"0"));
  })();

  /* ===== 全削除 ===== */
  $("wipeAll").addEventListener("click",()=>{
    if(!confirm("この端末に保存された全案件・全入力を完全に削除します。よろしいですか？")) return;
    try{
      localStorage.removeItem(KEY_MAIN); localStorage.removeItem(KEY_BACKUP);
      localStorage.removeItem(KEY_SNAP); localStorage.removeItem(KEY_SNAP+"_t");
    }catch(e){}
    S.cases={}; S.order=[]; S.current=""; ensureDefault(); persist(); fillCases(); render();
    alert("この端末の保存データを削除しました。");
  });

  /* ===== エラー表示（Script error は抑制） ===== */
  const showErr=(m)=>{ const el=$("inlineError"); if(!el) return; el.textContent=m||""; el.style.display=m?"block":"none"; };
  addEventListener("error",e=>{ if(!e) return; const m=(e.error&&e.error.message)||e.message||""; if(m && m!=="Script error.") showErr("エラー: "+m); });
  addEventListener("unhandledrejection",e=>{ if(!e||!e.reason) return; const m=(typeof e.reason==="string")?e.reason:(e.reason.message||""); if(m) showErr("エラー: "+m); });
})();
</script>
</body>
</html>
