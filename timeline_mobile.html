<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>相談準備用：時系列メモ（モバイル版｜送信しません｜V10 r54）</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="法律相談の準備に使える時系列メモ。入力は端末のブラウザにのみ保存され、外部へは送信されません。スマートフォン向け。">
<meta name="referrer" content="no-referrer"><meta http-equiv="Referrer-Policy" content="no-referrer">
<meta name="robots" content="noindex, nofollow, noarchive">
<style>
/* ===== 基本トークン ===== */
#ktl-app{ --bg:#f7f8fb; --b:#111; --m:#666; --bd:#dcdfea; --acc:#0a58cc;
          --th:#eef2fb; --td:#fff; --grid-color:#000; --field:#cfd3e2; }
#ktl-app, #ktl-app *{ box-sizing:border-box; }
html,body{margin:0;padding:0;background:var(--bg);color:var(--b);
  font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP","Yu Gothic",Meiryo,sans-serif;}
.ktl-card{background:#fff;border:1px solid var(--bd);border-radius:12px;padding:12px 14px;margin:10px 0;box-shadow:0 1px 0 rgba(10,10,20,.02);overflow:hidden}
.ktl-muted{color:var(--m)}
#ktl-app .ver{font-size:12px;color:#666;margin-left:8px}

/* ラベル（checkbox 除く） */
#ktl-app label{display:block;margin:6px 0 4px;font-weight:600}
#ktl-app label > input:not([type="checkbox"]),
#ktl-app label > select,
#ktl-app label > textarea{ display:block; margin-top:6px; width:100%; }

/* 自動保存（チェックと文言を横並び） */
.ktl-checkRow{ display:flex; align-items:center; gap:8px; margin:2px 0 0; }
.ktl-checkRow input[type="checkbox"]{ width:20px; height:20px; margin:0; }
.ktl-checkRow label{ margin:0; font-weight:700; }

/* 入力コントロール（共通） */
#ktl-app input[type="text"],
#ktl-app input[type="date"],
#ktl-app input[type="time"],
#ktl-app select{
  width:100%; max-width:100%; font-size:16px; line-height:1.25;
  padding:12px; border:1px solid var(--field); border-radius:10px; background:#fff; color:#111;
  min-height:44px; height:44px; -webkit-appearance:none; appearance:none;
}
#ktl-app textarea{
  width:100%; max-width:100%; font-size:16px; line-height:1.5;
  padding:12px; border:1px solid var(--field); border-radius:10px; background:#fff;
  min-height:120px; resize:vertical;
}
/* フォーム側：関与者／場所／証拠 */
#evActor,#evPlace,#evEvidence{ font-size:16px; min-height:44px; height:44px; }

/* カレンダー/時計アイコン（線画） */
.ktl-dateWrap,.ktl-timeWrap{ position:relative; }
.ktl-dateWrap input,.ktl-timeWrap input{ padding-right:38px; }
.ktl-dateWrap::after,.ktl-timeWrap::after{
  content:""; position:absolute; right:10px; top:52%; transform:translateY(-50%);
  width:16px; height:16px; pointer-events:none; opacity:.9; background-repeat:no-repeat; background-position:center; background-size:16px 16px;
}
.ktl-dateWrap::after{
  background-image:url("data:image/svg+xml;utf8,\
<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='1.6' stroke-linecap='round' stroke-linejoin='round'><rect x='3' y='5' width='18' height='16' rx='2' ry='2'/><path d='M16 3v4M8 3v4M3 10h18'/></svg>");
}
.ktl-timeWrap::after{
  background-image:url("data:image/svg+xml;utf8,\
<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='1.6' stroke-linecap='round' stroke-linejoin='round'><circle cx='12' cy='12' r='9'/><path d='M12 7v6l4 2'/></svg>");
}

/* ▼ 案件（ラベル＋セレクト横並び） */
.ktl-caseRow1{ display:grid; grid-template-columns:auto 1fr; column-gap:12px; align-items:center; }
.ktl-caseRow1 > label{ margin:0; font-weight:700; white-space:nowrap; }
.ktl-combo{ position:relative; width:100%; max-width:100%; }
#caseSelect{
  width:100%; padding-right:40px !important;
  -webkit-appearance:none !important; appearance:none !important;
  background-color:#fff !important;
  background-image:url("data:image/svg+xml;utf8,\
<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23666'><path d='M7 10l5 5 5-5z'/></svg>") !important;
  background-repeat:no-repeat !important;
  background-position:right 10px center !important;
  background-size:16px 16px !important;
}

/* ▼ 2行目（案件ボタン群） */
.ktl-caseRow2{ display:flex; gap:8px; margin-top:16px; flex-wrap:wrap; }

/* ▼ 種別セレクト矢印（フォーム＆編集） */
.ktl-selectWrap select{
  -webkit-appearance:none !important; appearance:none !important;
  padding-right:36px !important;
  background-color:#fff !important;
  background-image:url("data:image/svg+xml;utf8,\
<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23666'><path d='M7 10l5 5 5-5z'/></svg>") !important;
  background-repeat:no-repeat !important;
  background-position:right 10px center !important;
  background-size:16px 16px !important;
}

/* ボタン */
.ktl-btn{padding:9px 12px;border:1px solid #333;border-radius:10px;background:#fff;cursor:pointer;font-size:15px;white-space:nowrap}
.ktl-btn-plain{border:1px solid #999}
.ktl-btn-warn{border-color:#b11;color:#b11}
.ktl-btn-primary{border-color:var(--acc);color:var(--acc);font-weight:700}

/* ===== 一覧（画面） ===== */
.ktl-tableWrap{position:relative;padding:0;margin:0;overflow-x:hidden}
table.ktl-list{width:100%;max-width:100%;border-collapse:collapse;table-layout:fixed;background:var(--td);position:relative;z-index:1;margin:0;border:0}
table.ktl-list thead th{text-align:left;padding:6px 6px;font-weight:700;border:0;background:var(--th)}
table.ktl-list tbody td{padding:6px 6px;vertical-align:top;border:0}
#ktl-app table.ktl-list th,
#ktl-app table.ktl-list td{
  white-space:normal;word-break:break-word;overflow-wrap:anywhere;hyphens:auto;
  line-height:1.28 !important; font-size:11px !important; min-width:0;max-width:100%;
}
/* 日付2行クランプ */
.ktl-2lines{
  display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical;
  overflow:hidden; white-space:normal !important; line-height:1.28 !important;
  overflow-wrap:anywhere; word-break:break-word;
}
.ktl-list td:nth-child(8){ word-break:break-all; } /* 証拠列の英数字折返し */
.ktl-list th:nth-child(1), .ktl-list td:nth-child(1){ text-align:center }
.ktl-list tbody td:nth-child(1){ vertical-align:middle }
table.ktl-list td.ktl-pre{white-space:pre-wrap !important;}
.ktl-nowrap{white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
/* 罫線レイヤ（SVG） */
.ktl-gridlayer{position:absolute;left:0;top:0;width:100%;height:100%;pointer-events:none;z-index:3}
.ktl-gridlayer svg{width:100%;height:100%;display:block;shape-rendering:crispEdges}

/* 操作ボタン（小型） */
.ktl-list td:last-child{ padding:3px; overflow:hidden; text-align:center; }
.ktl-actions{ display:flex; flex-direction:column; gap:3px; align-items:center; justify-content:center; min-width:0; }
.ktl-actions .ktl-btn{
  writing-mode: vertical-rl; text-orientation: upright;
  display:inline-flex; align-items:center; justify-content:center;
  min-height:42px; min-width:16px; padding:2px 1px;
  font-size:8px; line-height:1; letter-spacing:.06em;
  border-radius:10px; white-space:nowrap; overflow:hidden; text-overflow:clip; transform:translateZ(0);
}

/* 見出しとPDFボタン */
.ktl-cardHead{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:8px}

/* 2列グリッド（フォーム） */
.ktl-grid{display:grid;grid-template-columns:minmax(0,1fr) minmax(0,1fr);gap:10px}
.ktl-grid .ktl-col2{grid-column:1 / -1}

/* カウンタ（内容の直下） */
.ktl-counter{display:block;margin:6px 0 0 2px;font-size:13px;color:#666}

/* PDFメッセージ */
#pdfStatus{margin-top:6px;font-size:13px;color:#333;line-height:1.4}
#pdfStatus a{color:#0a58cc;text-decoration:underline}

/* 印刷レイヤ（iOS対策） */
#PRINT_SHEET{ position:fixed; left:0; top:0; width:100vw; max-width:960px; visibility:hidden; pointer-events:none; z-index:9990; }

/* ▼ メモ枠：削除ボタンを右寄せ */
#memoCard .ktl-bottomRight{ display:flex; justify-content:flex-end; margin-top:10px; }

/* ===== 編集ダイアログ：無スクロール・枠線強調 ===== */
#editDlg{
  padding:0; border:0; border-radius:14px;
  width:min(520px, 92vw); max-width:92vw;
  max-height:86vh; overflow:hidden;
}
#editDlg::backdrop{ background:rgba(0,0,0,.35); }
#editDlg .ktl-dlgHead{ padding:8px 12px; border-bottom:1px solid #eee; font-weight:700; font-size:16px; }
#editDlg .ktl-dlgBody{ padding:8px 10px; }
#editDlg .ktl-dlgBody .ktl-grid{ grid-template-columns:1fr 1fr; gap:8px; }
#editDlg label{ display:block; margin:2px 0 2px; font-weight:600; }
/* ← ここで濃い枠線を指定（必須項目見やすく） */
#editDlg input[type="text"],
#editDlg input[type="date"],
#editDlg input[type="time"],
#editDlg select{
  width:100%; font-size:16px; line-height:1.2;
  padding:8px 10px; background:#fff; color:#111;
  border:1.5px solid #9aa4c8; border-radius:10px;
  min-height:36px; height:36px; -webkit-appearance:none; appearance:none;
}
#editDlg textarea{
  width:100%; font-size:16px; line-height:1.35;
  padding:8px 10px; background:#fff;
  border:1.5px solid #9aa4c8; border-radius:10px;
  min-height:68px; max-height:84px; resize:vertical;
}
#editDlg .ktl-dlgFoot{ padding:8px 10px; border-top:1px solid #eee; display:flex; gap:8px; justify-content:flex-end; }
/* ダイアログ本文を必要に応じて縮小して1画面に収める */
#editDlg .ktl-dlgBody{ transform-origin: top center; will-change: transform; }
</style>
</head>

<body>
<div id="ktl-app" style="max-width:960px;margin:12px auto 60px;padding:0 12px;">

  <!-- ▼ 時系列メモ -->
  <div class="ktl-card" id="memoCard">
    <h1 style="margin:0 0 6px;font-size:18px">相談準備用・時系列メモ（送信されません）
      <span class="ver">V10 r54</span>
    </h1>
    <div class="ktl-checkRow">
      <input type="checkbox" id="autoSave">
      <label for="autoSave">変更のたびに自動保存</label>
    </div>
    <p class="ktl-muted" style="line-height:1.6;font-size:14px;margin-top:8px">
      入力は<strong>この端末のブラウザにのみ保存</strong>され、<strong>外部には送信されません</strong>。
    </p>
    <div class="ktl-bottomRight">
      <button id="wipeAll" class="ktl-btn ktl-btn-warn">全データ削除（この端末）</button>
    </div>
  </div>

  <!-- ▼ 案件 -->
  <div class="ktl-card">
    <div class="ktl-caseRow1">
      <label for="caseSelect">案件：</label>
      <div class="ktl-combo"><select id="caseSelect"></select></div>
    </div>
    <div class="ktl-caseRow2">
      <button id="newCase" class="ktl-btn ktl-btn-plain">新規案件</button>
      <button id="renameCase" class="ktl-btn ktl-btn-plain">名前変更</button>
      <button id="dupCase"   class="ktl-btn ktl-btn-plain">複製</button>
      <button id="deleteCase" class="ktl-btn ktl-btn-warn">案件削除</button>
    </div>
  </div>

  <!-- ▼ 一覧 -->
  <div class="ktl-card">
    <div class="ktl-cardHead">
      <h2 style="margin:0;font-size:16px">時系列一覧</h2>
      <div>
        <button id="pdfBtn" class="ktl-btn ktl-btn-primary">PDF</button>
        <div id="pdfStatus"></div>
      </div>
    </div>
    <div class="ktl-tableWrap" id="tableWrap">
      <div class="ktl-gridlayer" id="gridlayer"><svg></svg></div>
      <table id="listTable" class="ktl-list">
        <colgroup>
          <!-- #5 / 日付17 / 時刻9 / 種別11 / 関与者11 / 場所11 / 内容20 / 証拠8 / 操作8 -->
          <col style="width:5%"><col style="width:17%"><col style="width:9%"><col style="width:11%">
          <col style="width:11%"><col style="width:11%"><col style="width:20%"><col style="width:8%"><col style="width:8%">
        </colgroup>
        <thead><tr>
          <th data-field="index">#</th>
          <th data-field="date">日付</th>
          <th data-field="time">時刻</th>
          <th data-field="type">種別</th>
          <th data-field="actor">関与者</th>
          <th data-field="place">場所</th>
          <th data-field="fact">内容（事実）</th>
          <th data-field="evidence">証拠</th>
          <th data-field="actions" data-pdf="0">操作</th>
        </tr></thead>
        <tbody id="listBody"><tr><td colspan="9" class="ktl-muted">まだ追加がありません</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- ▼ 追加フォーム -->
  <div class="ktl-card">
    <h2 style="font-size:16px">出来事の追加</h2>
    <div class="ktl-grid">
      <div><label class="ktl-dateWrap">発生日（開始）<input id="evDate" type="date" placeholder="yyyy/mm/dd"></label></div>
      <div><label class="ktl-timeWrap">発生時刻（任意）<input id="evTime" type="time"></label></div>
      <div><label class="ktl-selectWrap">種別
        <select id="evType">
          <option>連絡</option><option>支払い</option><option>通知</option><option>契約</option>
          <option>滞納</option><option>登記</option><option>DV</option><option>その他</option>
        </select>
      </label></div>
      <div><label>関与者（誰が）<input id="evActor" placeholder="例：相手方／自分／子"></label></div>
      <div><label>場所（任意）<input id="evPlace" placeholder="例：自宅／職場／LINE"></label></div>
      <div><label>裏付け証拠（タイトルのみでも可）<input id="evEvidence" placeholder="例：スクショ（2025-05-10）"></label></div>
      <div class="ktl-col2">
        <label>内容（事実ベース・140字まで）<textarea id="evFact" maxlength="140"></textarea></label>
        <small id="counter" class="ktl-counter">0/140</small>
      </div>
      <div class="ktl-col2" style="margin-top:6px; display:flex; gap:8px; align-items:center; justify-content:flex-end;">
        <button id="addBtn" class="ktl-btn ktl-btn-primary">＋ この内容を追加</button>
      </div>
      <div class="ktl-col2" style="margin-top:4px; display:flex; gap:8px; align-items:center; justify-content:flex-end;">
        <button id="saveNow" class="ktl-btn ktl-btn-primary">保存（この端末）</button>
        <span id="unsaved" class="ktl-muted" style="display:none;">● 未保存あり</span>
      </div>
    </div>
    <div id="inlineError" class="ktl-muted" style="color:#b11;margin-top:6px;"></div>
  </div>
</div>

<div id="PRINT_SHEET"></div>

<!-- ▼ 編集ダイアログ（2列・自動スケール） -->
<dialog id="editDlg">
  <div class="ktl-dlgHead">編集</div>
  <div class="ktl-dlgBody">
    <div class="ktl-grid">
      <div><label class="ktl-dateWrap">発生日<input id="edDate" type="date"></label></div>
      <div><label class="ktl-timeWrap">時刻<input id="edTime" type="time"></label></div>
      <div><label class="ktl-selectWrap">種別
        <select id="edType">
          <option>連絡</option><option>支払い</option><option>通知</option><option>契約</option>
          <option>滞納</option><option>登記</option><option>DV</option><option>その他</option>
        </select>
      </label></div>
      <div><label>関与者<input id="edActor"></label></div>
      <div><label>場所<input id="edPlace"></label></div>
      <div><label>証拠<input id="edEvidence"></label></div>
      <div class="ktl-col2"><label>内容<textarea id="edFact" maxlength="140"></textarea></label></div>
    </div>
  </div>
  <div class="ktl-dlgFoot">
    <button id="editSave" class="ktl-btn ktl-btn-primary">保存</button>
    <button id="editCancel" class="ktl-btn ktl-btn-plain">キャンセル</button>
  </div>
</dialog>

<script>
(function(){
  "use strict";
  var $=function(id){ return document.getElementById(id); };

  /* ====== 保存キー & 状態 ====== */
  var KEY_MAIN   ="KAWAI_TIMELINE_CASESAFE_V1";
  var KEY_BACKUP = KEY_MAIN + "_BACKUP";
  var KEY_SNAP   = KEY_MAIN + "_SNAPSHOTS";
  var SNAP_MAX   = 5;
  var SNAP_MINT  = 60*1000;

  var S={cases:{},order:[],current:"",meta:{v:"r54",updatedAt:Date.now()}};
  var storeOK=false, LAST_SNAP_AT=0;

  var today = function(){ return new Date().toISOString().slice(0,10); };
  var nowStr=function(){ var d=new Date(),p=function(n){return String(n).padStart(2,'0');}; return d.getFullYear()+p(d.getMonth()+1)+p(d.getDate())+"_"+p(d.getHours())+p(d.getMinutes()); };

  try{ localStorage.setItem("__t","1"); localStorage.removeItem("__t"); storeOK=true; }catch(e){ storeOK=false; }

  var safeParse=function(str){ try{ return JSON.parse(str); }catch(_){ return null; } };
  var isValidStore=function(o){
    if(!o || typeof o!=="object" || !o.cases || typeof o.cases!=="object") return false;
    if(!Array.isArray(o.order)) o.order=Object.keys(o.cases);
    return true;
  };
  var eventsTotal=function(o){
    try{
      var n=0, k, a;
      for(k in (o.cases||{})){ a=o.cases[k]; if(Array.isArray(a)) n+=a.length; }
      return n;
    }catch(_){ return 0; }
  };

  function persist(){
    if(!storeOK) return;
    try{
      S.meta = {v:"r54", updatedAt: Date.now(), total: eventsTotal(S)};
      var str=JSON.stringify(S);
      localStorage.setItem(KEY_MAIN, str);
      localStorage.setItem(KEY_BACKUP, str);
      if(Date.now()-LAST_SNAP_AT >= SNAP_MINT){
        LAST_SNAP_AT=Date.now();
        var snaps = safeParse(localStorage.getItem(KEY_SNAP)) || [];
        if(str.length < 400000){
          snaps.push({t: Date.now(), d: str});
          while(snaps.length > SNAP_MAX) snaps.shift();
          localStorage.setItem(KEY_SNAP, JSON.stringify(snaps));
        }
      }
    }catch(e){}
  }

  function loadFromStr(str){
    var o=safeParse(str); if(!isValidStore(o)) return false;
    S.cases=o.cases; S.order=o.order||Object.keys(o.cases);
    S.current=(o.current&&o.cases[o.current])?o.current:(S.order[0]||"");
    S.meta=o.meta||{v:"r54",updatedAt:Date.now()};
    normalizeOrder(); return true;
  }

  function tryLoadAll(){
    if(storeOK){
      var mainStr=localStorage.getItem(KEY_MAIN);
      if(mainStr && loadFromStr(mainStr)) return "main";
      var bkStr=localStorage.getItem(KEY_BACKUP);
      if(bkStr && loadFromStr(bkStr)) return "backup";
      var snaps = safeParse(localStorage.getItem(KEY_SNAP)) || [];
      if(snaps.length){
        var last=snaps[snaps.length-1];
        if(last && last.d && loadFromStr(last.d)) return "snapshot";
      }
    }
    return "";
  }

  function normalizeOrder(){
    var names=Object.keys(S.cases);
    var seen={}, i, out=[];
    for(i=0;i<(S.order||[]).length;i++){
      var n=S.order[i];
      if(names.indexOf(n)!==-1 && !seen[n]){ out.push(n); seen[n]=true; }
    }
    for(i=0;i<names.length;i++){
      var nm=names[i];
      if(!seen[nm]){ out.push(nm); seen[nm]=true; }
    }
    S.order=out;
  }

  function ensureDefault(){
    if(!S.order.length){
      var n="案件A_"+today();
      S.cases[n]=[]; S.order=[n]; S.current=n;
    }
  }

  function events(){ return S.cases[S.current]||(S.cases[S.current]=[]); }

  function fillCaseSelect(){
    var sel=$("caseSelect"); if(!sel) return;
    sel.innerHTML="";
    for(var i=0;i<S.order.length;i++){
      var n=S.order[i];
      var op=document.createElement("option"); op.value=n; op.textContent=n;
      if(n===S.current) op.selected=true;
      sel.appendChild(op);
    }
  }

  function cellText(t,cls){ var x=document.createElement("td"); if(cls) x.className=cls; x.textContent=t||""; return x; }
  function cell2lines(t){ var td=document.createElement("td"); var sp=document.createElement("span"); sp.className="ktl-2lines"; sp.textContent=t||""; td.appendChild(sp); return td; }

  function render(){
    var tbody=$("listBody"); if(!tbody) return;
    tbody.innerHTML="";
    var arr=events().slice().map(function(ev,idx){return {ev:ev, idx:idx};})
      .sort(function(a,b){ return ((a.ev.date||"")+(a.ev.time||"")).localeCompare((b.ev.date||"")+(b.ev.time||"")); });
    if(!arr.length){
      var tr=document.createElement("tr"); var td=document.createElement("td");
      td.colSpan=9; td.className="ktl-muted"; td.textContent="まだ追加がありません";
      tr.appendChild(td); tbody.appendChild(tr); drawGrid(); return;
    }
    arr.forEach(function(item,i){
      var e=item.ev; var tr=document.createElement("tr");
      tr.appendChild(cellText(i+1));
      tr.appendChild(cell2lines(e.date));
      tr.appendChild(cellText(e.time,"ktl-nowrap"));
      tr.appendChild(cellText(e.type));
      tr.appendChild(cellText(e.actor));
      tr.appendChild(cellText(e.place));
      tr.appendChild(cellText(e.fact,"ktl-pre"));
      tr.appendChild(cellText(e.evidence));
      var tdAct=document.createElement("td"); tdAct.className="ktl-actions";
      var bE=document.createElement("button"); bE.textContent="編集"; bE.className="ktl-btn ktl-btn-plain";
      var bD=document.createElement("button"); bD.textContent="削除"; bD.className="ktl-btn ktl-btn-warn";
      bE.onclick=function(){ openEdit(item.idx); };
      bD.onclick=function(){ if(confirm("この行を削除します。よろしいですか？")){ events().splice(item.idx,1); saveMaybe(); render(); } };
      tdAct.appendChild(bE); tdAct.appendChild(bD); tr.appendChild(tdAct);
      tbody.appendChild(tr);
    });
    drawGrid(); setTimeout(drawGrid,50); setTimeout(drawGrid,300);
  }

  /* ====== 罫線（SVG） ====== */
  function drawGrid(){
    var wrap=$("tableWrap"); if(!wrap) return;
    var table=wrap.querySelector("table"); var svg=wrap.querySelector(".ktl-gridlayer svg"); if(!table||!svg) return;
    svg.innerHTML="";
    var stroke=getComputedStyle(document.documentElement).getPropertyValue('--grid-color')||"#000";
    var sw=1, W=Math.round(table.offsetWidth), H=Math.round(table.offsetHeight);
    svg.setAttribute("viewBox","0 0 "+W+" "+H); svg.setAttribute("preserveAspectRatio","none");
    var th=table.tHead && table.tHead.rows[0]; if(!th) return;
    var rectT=table.getBoundingClientRect();
    var xs=[0]; var acc=0; Array.prototype.forEach.call(th.cells, function(c){ acc+=c.offsetWidth; xs.push(acc); });
    var ys=[0]; if(table.tBodies && table.tBodies.length){ Array.prototype.forEach.call(table.tBodies[0].rows, function(tr){ ys.push(Math.round(tr.getBoundingClientRect().bottom-rectT.top)); }); }
    var rect=document.createElementNS("http://www.w3.org/2000/svg","rect");
    rect.setAttribute("x",0.5); rect.setAttribute("y",0.5); rect.setAttribute("width",Math.max(0,W-1)); rect.setAttribute("height",Math.max(0,H-1));
    rect.setAttribute("fill","none"); rect.setAttribute("stroke",stroke.trim()||"#000"); rect.setAttribute("stroke-width",sw); rect.setAttribute("vector-effect","non-scaling-stroke"); svg.appendChild(rect);
    xs.forEach(function(x,i){ if(i===0||i===xs.length-1) return; var cx=Math.floor(x)+0.5;
      var ln=document.createElementNS("http://www.w3.org/2000/svg","line");
      ln.setAttribute("x1",cx); ln.setAttribute("y1",0); ln.setAttribute("x2",cx); ln.setAttribute("y2",H);
      ln.setAttribute("stroke",stroke.trim()||"#000"); ln.setAttribute("stroke-width",sw); ln.setAttribute("vector-effect","non-scaling-stroke"); svg.appendChild(ln); });
    ys.forEach(function(y,i){ if(i===0||i===ys.length-1) return; var cy=Math.floor(y)+0.5;
      var ln2=document.createElementNS("http://www.w3.org/2000/svg","line");
      ln2.setAttribute("x1",0); ln2.setAttribute("y1",cy); ln2.setAttribute("x2",W); ln2.setAttribute("y2",cy);
      ln2.setAttribute("stroke",stroke.trim()||"#000"); ln2.setAttribute("stroke-width",sw); ln2.setAttribute("vector-effect","non-scaling-stroke"); svg.appendChild(ln2); });
  }
  window.addEventListener("resize", drawGrid);
  window.addEventListener("orientationchange", drawGrid);

  /* ====== 追加・編集 ====== */
  function bindAddEdit(){
    $("evFact").addEventListener("input",function(){ $("counter").textContent=(($("evFact").value)||"").length+"/140"; });
    $("addBtn").onclick=function(){
      var e={date:$("evDate").value||"", time:$("evTime").value||"", type:$("evType").value||"",
             actor:($("evActor").value||"").trim(), place:($("evPlace").value||"").trim(),
             fact:($("evFact").value)||"", evidence:($("evEvidence").value||"").trim()};
      if(!e.date||!e.fact){ $("inlineError").textContent="日付 と 内容 は必須です"; return; } $("inlineError").textContent="";
      events().push(e); saveMaybe(); render();
    };
  }

  var editingIndex=-1; var dlg=$("editDlg");
  function fitEditDialog(){
    if(!dlg || !dlg.open) return;
    var head = dlg.querySelector('.ktl-dlgHead');
    var body = dlg.querySelector('.ktl-dlgBody');
    var foot = dlg.querySelector('.ktl-dlgFoot');
    if(!body) return;
    body.style.transform='none';
    var maxH = Math.floor(window.innerHeight * 0.86);
    var chromeH = (head?head.offsetHeight:0) + (foot?foot.offsetHeight:0) + 12;
    var avail = Math.max(100, maxH - chromeH);
    var need = body.scrollHeight;
    var scale = (need>avail) ? (avail/need) : 1;
    if(scale < 1){
      body.style.transform='scale('+scale.toFixed(3)+')';
    }else{
      body.style.transform='none';
    }
  }
  function openEdit(i){
    editingIndex=i; var ev=events()[i]; if(!ev) return;
    if(!(dlg && dlg.showModal)){  /* 旧ブラウザ簡易フォールバック */
      var nd=prompt("発生日 (YYYY-MM-DD)", ev.date||""); if(nd===null) return;
      var nt=prompt("時刻 (HH:MM)", ev.time||""); if(nt===null) return;
      var ty=prompt("種別", ev.type||""); if(ty===null) return;
      var ac=prompt("関与者", ev.actor||""); if(ac===null) return;
      var pl=prompt("場所", ev.place||""); if(pl===null) return;
      var fa=prompt("内容", ev.fact||""); if(fa===null) return;
      var evd=prompt("証拠", ev.evidence||""); if(evd===null) return;
      var nv={date:nd,time:nt,type:ty,actor:ac,place:pl,fact:fa,evidence:evd};
      if(!nv.date||!nv.fact){ alert("日付 と 内容 は必須です"); return; }
      events()[i]=nv; saveMaybe(); render(); return;
    }
    $("edDate").value=ev.date||""; $("edTime").value=ev.time||""; $("edType").value=ev.type||"その他";
    $("edActor").value=ev.actor||""; $("edPlace").value=ev.place||""; $("edFact").value=ev.fact||""; $("edEvidence").value=ev.evidence||"";
    dlg.showModal();
    setTimeout(fitEditDialog, 0);
  }
  window.openEdit=openEdit;

  function bindEditDialog(){
    if(!$("editCancel")||!$("editSave")) return;
    $("editCancel").onclick=function(){ dlg.close(); };
    $("editSave").onclick=function(){
      var i=editingIndex; if(i<0){ dlg.close(); return; }
      var nv={date:$("edDate").value||"", time:$("edTime").value||"", type:$("edType").value||"",
              actor:($("edActor").value||"").trim(), place:($("edPlace").value||"").trim(),
              fact:($("edFact").value||"").trim(), evidence:($("edEvidence").value||"").trim()};
      if(!nv.date||!nv.fact){ alert("日付 と 内容 は必須です"); return; }
      events()[i]=nv; saveMaybe(); render(); dlg.close();
    };
    window.addEventListener('resize', fitEditDialog);
    window.addEventListener('orientationchange', function(){ setTimeout(fitEditDialog, 250); });
  }

  /* ====== 保存UI ====== */
  var DIRTY=false;
  function showUnsaved(on){ var u=$("unsaved"); if(u) u.style.display=on?"inline":"none"; }
  function persistAndMark(){ persist(); DIRTY=false; showUnsaved(false); }
  function saveMaybe(){ if($("autoSave").checked){ persistAndMark(); }else{ DIRTY=true; showUnsaved(true); } }
  function bindSave(){
    $("saveNow").onclick=function(){ persistAndMark(); alert("この端末のブラウザに保存しました。"); };
    window.addEventListener("beforeunload", function(e){ if(!$("autoSave").checked && DIRTY){ e.preventDefault(); e.returnValue=""; } });
  }

  /* ====== 案件操作 ====== */
  function ensureUniqueName(base){
    var name=base||"案件", i=2;
    while(S.cases[name]){ name=base+" ("+(i++)+")"; }
    return name;
  }
  function defaultCaseName(){
    var len=(S.order && S.order.length) ? S.order.length : 0;
    return "案件"+(len+1)+"_"+today();
  }
  function addCaseFlow(){
    var input = prompt("新しい案件名を入力してください", defaultCaseName());
    if(input===null) return;
    var base=(input||"").trim(); if(!base) return;
    var name=ensureUniqueName(base);
    S.cases[name]=[];
    if(S.order.indexOf(name)===-1) S.order.push(name);
    S.current=name;
    persistAndMark(); fillCaseSelect(); render();
    alert("案件を作成しました："+name);
  }
  function renameCaseFlow(){
    var old=S.current; if(!old){ alert("案件が選択されていません。"); return; }
    var input = prompt("案件名を変更します", old);
    if(input===null) return;
    var name=(input||"").trim(); if(!name || name===old) return;
    if(S.cases[name] && name!==old){ alert("同名の案件が既にあります。別の名前にしてください。"); return; }
    S.cases[name]=S.cases[old]; delete S.cases[old];
    S.order=S.order.map(function(n){ return n===old? name : n; });
    S.current=name;
    persistAndMark(); fillCaseSelect(); render();
  }
  function duplicateCaseFlow(){
    var src=S.current; if(!src){ alert("案件が選択されていません。"); return; }
    var name=ensureUniqueName(src+"（複製）");
    S.cases[name]=JSON.parse(JSON.stringify(S.cases[src]||[]));
    if(S.order.indexOf(name)===-1) S.order.push(name);
    S.current=name;
    persistAndMark(); fillCaseSelect(); render();
    alert("案件を複製しました："+name);
  }
  function deleteCaseFlow(){
    var cur=S.current; if(!cur){ alert("案件が選択されていません。"); return; }
    var cnt=(S.cases[cur]||[]).length;
    if(!confirm("案件「"+cur+"」を削除します（行数："+cnt+"）。よろしいですか？")) return;
    delete S.cases[cur];
    S.order=S.order.filter(function(n){ return n!==cur; });
    S.current=S.order[0]||"";
    if(!S.current){ ensureDefault(); }
    persistAndMark(); fillCaseSelect(); render();
  }
  function bindCaseButtons(){
    var b1=$("newCase"), b2=$("renameCase"), b3=$("dupCase"), b4=$("deleteCase");
    if(b1) b1.addEventListener("click", addCaseFlow);
    if(b2) b2.addEventListener("click", renameCaseFlow);
    if(b3) b3.addEventListener("click", duplicateCaseFlow);
    if(b4) b4.addEventListener("click", deleteCaseFlow);
    var sel=$("caseSelect");
    if(sel) sel.addEventListener("change", function(e){
      var v=e.target.value; if(S.cases[v]){ S.current=v; persist(); render(); }
    });
  }

  /* ====== PDF ====== */
  var PDF_W_PT=595.28, PDF_H_PT=841.89, PDF_MARGIN_PT=24, PX2PT=72/96;
  var measureCtx=(function(){ var c=document.createElement("canvas"); c.width=2; c.height=2; return c.getContext("2d"); })();
  function wrapLine(ctx, text, maxW, font){ ctx.save(); ctx.font=font; var lines=[], line="", i, ch, test; text=String(text||""); for(i=0;i<text.length;i++){ ch=text.charAt(i); test=line+ch; if(ctx.measureText(test).width<=maxW || line===""){ line=test; } else { lines.push(line); line=ch; } } if(line!=="") lines.push(line); ctx.restore(); return lines.length?lines:[""]; }
  function wrapText(ctx, text, maxW, font){ var paras=String(text||"").split(/\r\n|\r|\n/), out=[], i, chunk; for(i=0;i<paras.length;i++){ chunk=wrapLine(ctx,paras[i],maxW,font); Array.prototype.push.apply(out,chunk); if(i<paras.length-1) out.push(""); } return out.length?out:[""]; }
  function getPdfColumnsFromDom(){
    var ths=[].slice.call(document.querySelectorAll('#listTable thead th'));
    var incl=ths.filter(function(th){ return th.getAttribute('data-pdf')!=='0' && th.offsetWidth>0; });
    var sumW = incl.reduce(function(s,th){return s+th.offsetWidth;},0)||1;
    return incl.map(function(th){
      var key = th.getAttribute('data-field') || th.textContent.replace(/\s+/g," ").trim();
      var w=(th.offsetWidth/sumW);
      var cfg={ key:key, t: th.textContent.trim(), w:w, align:null, nowrap:false, vcenter:false };
      if(key==='index'){ cfg.align='center'; cfg.vcenter=true; }
      if(key==='date'||key==='time'||key==='type'){ cfg.align='center'; }
      if(key==='time'){ cfg.nowrap=true; }
      return cfg;
    });
  }
  function collectRowsFromDom(cols){
    var tbody=document.querySelector('#listTable tbody'); if(!tbody) return [];
    var thAll=[].slice.call(document.querySelectorAll('#listTable thead th'));
    var targets=cols.map(function(c){
      var th=(thAll.find)? thAll.find(function(h){return ((h.getAttribute('data-field')||h.textContent.trim())===c.key);}) : null;
      return th ? th.cellIndex : -1;
    });
    var rows=[];
    [].slice.call(tbody.rows).forEach(function(tr){
      if(tr.cells.length===1 && tr.cells[0].classList.contains('ktl-muted')) return;
      var obj={}, i, tdIdx, td, text;
      for(i=0;i<targets.length;i++){
        tdIdx=targets[i]; if(tdIdx<0) continue;
        td=tr.cells[tdIdx];
        text=(td? (td.innerText || td.textContent) : "");
        text=(text||"").replace(/\s+\n/g,"\n").trim();
        obj[cols[i].key]=text;
      }
      rows.push(obj);
    });
    return rows;
  }
  function buildPageCanvases(list, cols){
    var pageWpx=Math.ceil(PDF_W_PT/PX2PT), pageHpx=Math.ceil(PDF_H_PT/PX2PT);
    var SCALE=2; var marginPx=Math.floor(PDF_MARGIN_PT/PX2PT); var innerW=pageWpx - marginPx*2; var innerH=pageHpx - marginPx*2;
    var colW=cols.map(function(c){return Math.round(c.w*innerW);}); var diff=innerW - colW.reduce(function(a,b){return a+b;},0); colW[colW.length-1]+=diff;
    var headFont="bold 15px -apple-system,BlinkMacSystemFont,'Segoe UI','Noto Sans JP','Yu Gothic',Meiryo,sans-serif";
    var cellFont="13px -apple-system,BlinkMacSystemFont,'Segoe UI','Noto Sans JP','Yu Gothic',Meiryo,sans-serif";
    var lineH=19, padY=8, padX=12, headH=32;
    var rows=list.map(function(e,i){
      var vals=cols.map(function(c){ return c.key==='index' ? String(i+1) : (e[c.key]||""); });
      var lines=vals.map(function(v,ci){ var w=Math.max(12,colW[ci]-padX*2-2); return cols[ci].nowrap ? [ (v||"") ] : wrapText(measureCtx,v,w,cellFont); });
      var blockHs=lines.map(function(ls){ return Math.max(lineH, ls.length*lineH); });
      var h=Math.max(lineH + padY*2, Math.max.apply(null, blockHs) + padY*2);
      return {vals:vals,lines:lines,blockHs:blockHs,h:h};
    });
    var pages=[], idx=0;
    while(idx<rows.length){
      var c=document.createElement("canvas"); c.width=Math.floor(pageWpx*SCALE); c.height=Math.floor(PDF_H_PT/PX2PT*SCALE);
      var ctx=c.getContext("2d"); ctx.scale(SCALE,SCALE); ctx.imageSmoothingEnabled=false; ctx.fillStyle="#fff"; ctx.fillRect(0,0,c.width,c.height); ctx.strokeStyle="#000"; ctx.lineWidth=1;
      var line={ rect:function(x,y,w,h){ctx.strokeRect(Math.floor(x)+0.5,Math.floor(y)+0.5,Math.floor(w),Math.floor(h));},
                 v:function(x,y1,y2){x=Math.floor(x)+0.5;y1=Math.floor(y1)+0.5;y2=Math.floor(y2)+0.5;ctx.beginPath();ctx.moveTo(x,y1);ctx.lineTo(x,y2);ctx.stroke();},
                 h:function(y,x1,x2){y=Math.floor(y)+0.5;x1=Math.floor(x1)+0.5;x2=Math.floor(x2)+0.5;ctx.beginPath();ctx.moveTo(x1,y);ctx.lineTo(x2,y);ctx.stroke();} };
      var x0=marginPx,y0=marginPx;
      ctx.fillStyle="#dbe8ff"; ctx.fillRect(x0,y0,innerW,headH);
      ctx.fillStyle="#000"; ctx.font=headFont; ctx.textBaseline="middle";
      var cx=x0; cols.forEach(function(cdef,i){ var tx=cdef.t; var txX=cx+padX; var wtx=measureCtx.measureText(tx).width; if(cdef.align==="center"){ txX=cx+(colW[i]-wtx)/2; } ctx.fillText(tx,Math.max(cx+padX,txX),y0+headH/2); cx+=colW[i]; });
      line.rect(x0,y0,innerW,headH); cx=x0; cols.forEach(function(cdef,i){ if(i>0) line.v(cx,y0,y0+headH); cx+=colW[i]; });
      var y=y0+headH; ctx.font=cellFont; ctx.textBaseline="top";
      for(; idx<rows.length; idx++){
        var r=rows[idx]; if(y + r.h > marginPx + innerH){ break; }
        line.rect(x0,y,innerW,r.h); var cx2=x0; cols.forEach(function(cdef,i){ if(i>0) line.v(cx2,y,y+r.h); cx2+=colW[i]; });
        var xx=x0;
        r.lines.forEach(function(ls,i){
          var colWidth=colW[i]; var blockH=r.blockHs[i]; var top = y + Math.max(padY, Math.floor((r.h - blockH)/2));
          ctx.save(); ctx.beginPath(); ctx.rect(Math.floor(xx)+1, Math.floor(y)+1, Math.floor(colWidth)-2, Math.floor(r.h)-2); ctx.clip();
          if(cols[i].vcenter){
            ctx.textBaseline="middle"; var tx=r.vals[i]||""; var tw=measureCtx.measureText(tx).width; var txX=xx + (colWidth - tw)/2; var txY=y + r.h/2 + 0.5; ctx.fillText(tx, txX, txY); ctx.textBaseline="top";
          }else{
            ls.forEach(function(ln,li){ var txX=xx + padX; if(cols[i].align==="center"){ var tw2=measureCtx.measureText(ln).width; txX=xx + (colWidth - tw2)/2; } ctx.fillText(ln, txX, top + li*lineH); });
          }
          ctx.restore(); xx+=colWidth;
        });
        y+=r.h;
      }
      ctx.fillStyle="#000"; ctx.fillRect(c.width-4, c.height-4, 1, 1);
      pages.push({canvas:c});
    }
    return pages;
  }
  function canvasToJpegBytes(canvas){
    var b64, binStr, bin;
    try{ b64=canvas.toDataURL("image/jpeg",0.92); } catch(e){ b64=canvas.toDataURL("image/jpeg",0.88); }
    binStr=b64.split(",").pop()||""; bin=atob(binStr); var u8=new Uint8Array(bin.length); for(var i=0;i<bin.length;i++) u8[i]=bin.charCodeAt(i); return u8;
  }
  function pdfFromImages(imgs, pageW, pageH, margin){
    pageW=pageW||595.28; pageH=pageH||841.89; margin=margin||24;
    var enc=new TextEncoder(); var parts=[]; var off=0; var xref=[0];
    var add=function(b){ parts.push(b); off+=b.length; }; var addS=function(s){ add(enc.encode(s)); };
    var obj=function(n,bufs){ xref[n]=off; addS(n+" 0 obj\n"); if(Array.isArray(bufs)){ for(var i=0;i<bufs.length;i++) add(bufs[i]); } else { addS(bufs); } addS("\nendobj\n"); };
    var W=pageW, H=pageH, N=imgs.length;
    var imgObj=function(i){return 3 + i*3;}, cntObj=function(i){return 3 + i*3 + 1;}, pagObj=function(i){return 3 + i*3 + 2;};
    addS("%PDF-1.4\n%\xE2\xE3\xCF\xD3\n");
    for(var i=0;i<N;i++){
      var it=imgs[i]; var bytes=it.bytes, wpx=it.wpx, hpx=it.hpx;
      var px2pt=72/96, wpt=wpx*px2pt/2, hpt=hpx*px2pt/2;
      var maxW=W-margin*2, maxH=H-margin*2; var sc=Math.min(maxW/wpt, maxH/hpt, 1);
      var dw=(wpt*sc).toFixed(2), dh=(hpt*sc).toFixed(2); var x=((W - wpt*sc)/2).toFixed(2), y=((H - hpt*sc)/2).toFixed(2);
      obj(imgObj(i),[ enc.encode("<< /Type /XObject /Subtype /Image /Width "+wpx+" /Height "+hpx+" /ColorSpace /DeviceRGB /BitsPerComponent 8 /Filter /DCTDecode /Length "+bytes.length+" >>\nstream\n"), bytes, enc.encode("\nendstream\n") ]);
      var content="q\n"+dw+" 0 0 "+dh+" "+x+" "+y+" cm\n/Im"+i+" Do\nQ";
      obj(cntObj(i),"<< /Length "+enc.encode(content).length+" >>\nstream\n"+content+"\nendstream");
      obj(pagObj(i),"<< /Type /Page /Parent 2 0 R /MediaBox [0 0 "+W+" "+H+"] /Resources << /XObject << /Im"+i+" "+imgObj(i)+" 0 R >> >> /Contents "+cntObj(i)+" 0 R >>");
    }
    var kids=[], i; for(i=0;i<N;i++){ kids.push(pagObj(i)+" 0 R"); }
    obj(2,"<< /Type /Pages /Count "+N+" /Kids [ "+kids.join(" ")+" ] >>");
    obj(1,"<< /Type /Catalog /Pages 2 0 R >>");
    var maxId=(N>0)?pagObj(N-1):2; var start=off; var xS="xref\n0 "+(maxId+1)+"\n0000000000 65535 f \n"; for(i=1;i<=maxId;i++){ var pos=(typeof xref[i]==="number")?xref[i]:0; xS+=String(pos).padStart(10,"0")+" 00000 "+(pos? "n":"f")+" \n"; } xS+="trailer << /Size "+(maxId+1)+" /Root 1 0 R >>\nstartxref\n"+start+"\n%%EOF";
    addS(xS); return new Blob(parts,{type:"application/pdf"});
  }
  function makePDF(){
    var thCols=getPdfColumnsFromDom(); var list=collectRowsFromDom(thCols);
    if(!list.length){ alert("PDFに出力できる行がありません。"); return; }
    var pages; try{ pages=buildPageCanvases(list, thCols); } catch(e){ alert("PDF作成で内部エラーが発生しました。もう一度お試しください。"); return; }
    var imgs=pages.map(function(p){return {bytes:canvasToJpegBytes(p.canvas), wpx:p.canvas.width, hpx:p.canvas.height};});
    var pdf=pdfFromImages(imgs); var url=URL.createObjectURL(pdf); var name="timeline_"+nowStr()+".pdf";
    var a=document.createElement("a"); a.href=url; a.download=name; a.rel="noopener noreferrer"; document.body.appendChild(a); a.click();
    var s=$("pdfStatus"); if(s){ s.innerHTML='PDFを作成し、ダウンロードを開始しました。保存できない場合は <a href="'+url+'" download="'+name+'">ここをタップして保存</a>（60秒以内）。<br><span class="ver">V10 r54</span>'; }
    setTimeout(function(){ try{ URL.revokeObjectURL(url); }catch(e){} try{ a.remove(); }catch(e){} if(s) s.textContent=""; }, 60000);
  }

  /* ====== 初期化・バインド ====== */
  function initAfterDom(){
    var mode=tryLoadAll(); if(!mode){ ensureDefault(); }
    normalizeOrder(); ensureDefault(); persist(); fillCaseSelect(); render();

    if($("evDate")) $("evDate").value=today();
    if($("counter")) $("counter").textContent="0/140";

    var savedAuto=(localStorage.getItem("__autosave__")==="1");
    var as=$("autoSave"); if(as){ as.checked=!!savedAuto; as.addEventListener("change", function(){ localStorage.setItem("__autosave__", as.checked?"1":"0"); }); }

    bindAddEdit(); bindEditDialog(); bindSave(); bindCaseButtons();
    var pb=$("pdfBtn"); if(pb) pb.addEventListener("click", makePDF);
  }
  if(document.readyState==="loading"){ document.addEventListener("DOMContentLoaded", initAfterDom); } else { initAfterDom(); }

  /* ====== 全削除 ====== */
  function wipeAllHandler(){
    if(!confirm("この端末に保存された全案件・全入力を完全に削除します。よろしいですか？")) return;
    try{ localStorage.removeItem(KEY_MAIN); localStorage.removeItem(KEY_BACKUP); localStorage.removeItem(KEY_SNAP); }catch(e){}
    S.cases={}; S.order=[]; S.current=""; S.meta={v:"r54",updatedAt:Date.now()};
    ensureDefault(); persist(); fillCaseSelect(); render();
    alert("この端末の保存データを削除しました。");
  }
  var w=$("wipeAll"); if(w){ if(document.readyState==="loading"){ document.addEventListener("DOMContentLoaded", function(){ $("wipeAll").onclick=wipeAllHandler; }); } else { w.onclick=wipeAllHandler; } }

  /* ====== エラー表示（一般的な "Script error." は非表示） ====== */
  function showError(msg){ var el=$("inlineError"); if(!el) return; el.textContent=msg||""; el.style.display=msg?"block":"none"; }
  window.addEventListener("error", function(e){
    if(!e) return;
    var m = (e.error && e.error.message) || e.message || "";
    if(m && m!=="Script error.") showError("エラー: "+m);
  });
  window.addEventListener("unhandledrejection", function(e){
    if(!e || !e.reason) return;
    var m = (typeof e.reason==="string")? e.reason : (e.reason.message || "");
    if(m) showError("エラー: " + m);
  });
})();
</script>
</body>
</html>
