<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>相談準備用：時系列メモ（送信しません） Revert v27 公開版</title>
<meta name="description" content="法律相談の準備に使える時系列メモ。入力内容は端末のブラウザにのみ保存され、当事務所や第三者へ送信されません。印刷（時系列一覧）から紙・PDFに出力できます。">

<!-- ▼ セキュリティ：このページだけで完結させ、外部送信・外部スクリプトを遮断 -->
<meta http-equiv="Content-Security-Policy"
      content="default-src 'self';
               img-src 'self' data:;
               style-src 'self' 'unsafe-inline';
               script-src 'self' 'unsafe-inline';
               connect-src 'none';
               object-src 'none';
               base-uri 'none';
               form-action 'none';
               frame-ancestors 'self'">

<style>
  :root{
    --bg:#f7f8fb; --b:#111; --m:#666; --bd:#dcdfea; --acc:#0a58cc;
    --th:#eef2fb; --td:#fff;
    --grid-color:#000; --grid-w:1px;
    --print-right-pad: 2mm; --print-table-width: 99.5%;
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--b);
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP","Yu Gothic",Meiryo,sans-serif;}
  .wrap{max-width:1080px;margin:16px auto 80px;padding:0 16px;}
  .card{background:#fff;border:1px solid var(--bd);border-radius:12px;padding:14px 16px;margin:12px 0;box-shadow:0 1px 0 rgba(10,10,20,.02)}
  h1{margin:0 0 8px;font-size:20px}
  h2{margin:0 0 10px;font-size:18px}
  .muted{color:var(--m)}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .btn{padding:9px 13px;border:1px solid #333;border-radius:8px;background:#fff;cursor:pointer;font-size:14px}
  .btn-plain{border:1px solid #999}
  .btn-warn{border-color:#b11;color:#b11}
  .btn-primary{border-color:var(--acc);color:var(--acc);font-weight:700}
  label{display:block;margin:6px 0 4px;font-weight:600}
  input,select,textarea{width:100%;box-sizing:border-box;padding:9px;border:1px solid #e0e0e0;border-radius:8px;background:#fff;font-size:14px}
  .grid{display:grid;grid-template-columns: repeat(4, 1fr); gap:10px}
  .grid .col2{grid-column: span 2}
  .grid .col3{grid-column: span 3}
  .grid .col4{grid-column: span 4}
  .spacer{flex:1}

  .tableWrap{position:relative;padding:0;margin:0}
  .gridlayer{position:absolute;left:0;top:0;width:100%;height:100%;pointer-events:none;z-index:2;color:var(--grid-color)}
  .gridlayer svg{width:100%;height:100%;display:block;shape-rendering:crispEdges}
  table.list{width:100%;border-collapse:collapse;table-layout:fixed;background:var(--td);position:relative;z-index:1;margin:0}
  table.list thead th{background:var(--th);text-align:left;padding:6px 8px;font-weight:700}
  table.list tbody td{padding:6px 8px;vertical-align:top}
  table.list, table.list thead th, table.list tbody td{border:0; box-sizing:border-box}
  table.list th, table.list td{white-space:normal;word-break:break-word;overflow-wrap:anywhere;font-size:13px}
  table.list td.pre{white-space:pre-wrap !important;}
  .nowrap{white-space:nowrap}
  .actions{display:flex;gap:4px}
  .actions .btn{padding:5px 8px;font-size:12px;line-height:1}

  /* 画面の列幅（9列=100%） */
  table.list col.col-no{width:4%}
  table.list col.col-date{width:12%}
  table.list col.col-time{width:6%}
  table.list col.col-type{width:6%}
  table.list col.col-actor{width:9%}
  table.list col.col-place{width:9%}
  table.list col.col-fact{width:39%}
  table.list col.col-evi{width:6%}
  table.list col.col-act{width:9%}

  /* 時系列一覧 見出しの右側に印刷ボタン */
  .cardHead{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:8px}

  /* 印刷：表のみ／青ヘッダを印刷／右端安全幅 */
  #PRINT_SHEET{ display:none; }
  @media print{
    @page { size: A4 portrait; margin: 10mm; }
    html, body { background:#fff; }
    * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; color-adjust: exact !important; }
    body > *:not(#PRINT_SHEET){ display:none !important; }
    #PRINT_SHEET{ display:block !important; padding-right: var(--print-right-pad) !important; }
    #PRINT_SHEET table{ width: var(--print-table-width) !important; border-collapse:collapse !important; table-layout:fixed !important; border:1px solid #000; box-sizing:border-box !important; margin:0; }
    #PRINT_SHEET th, #PRINT_SHEET td{ border:1px solid #000; padding:6px !important; font-size:12px !important; vertical-align:top; box-sizing:border-box !important; word-break:break-word !important; overflow-wrap:anywhere !important; }
    #PRINT_SHEET thead th{ background: var(--th) !important; color:#000 !important; }
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>相談準備用・時系列メモ（送信されません）</h1>
    <p class="muted" style="line-height:1.6">
      本ページは<strong>ご相談の準備や情報整理のためのツール</strong>です。<br>
      入力内容は<strong>ご利用の端末（ブラウザ）にのみ保存</strong>され、<strong>当事務所や第三者へは送信されません</strong>。
    </p>
    <div class="toolbar">
      <label style="display:inline-flex;gap:6px;align-items:center">
        <input type="checkbox" id="autoSave"> 変更のたびに自動保存
      </label>
      <button id="wipeAll" class="btn btn-warn">全データ削除（この端末）</button>
      <span class="spacer"></span>
      <!-- ご要望により、右下の小タグ3つは削除 -->
    </div>
  </div>

  <div class="card">
    <div class="toolbar">
      <label>案件：<select id="caseSelect"></select></label>
      <button id="newCase" class="btn btn-plain">新規案件</button>
      <button id="renameCase" class="btn btn-plain">名前変更</button>
      <button id="dupCase" class="btn btn-plain">複製</button>
      <button id="deleteCase" class="btn btn-warn">案件削除</button>
      <div class="spacer"></div>
      <!-- 印刷ボタンは下の「時系列一覧」カード内に配置 -->
    </div>
  </div>

  <div class="card">
    <div class="cardHead">
      <h2 style="margin:0">時系列一覧</h2>
      <button id="printBtn" class="btn btn-primary">印刷（時系列一覧）</button>
    </div>
    <div class="tableWrap" id="tableWrap">
      <div class="gridlayer" id="gridlayer"><svg></svg></div>
      <table id="listTable" class="list">
        <colgroup>
          <col class="col-no"><col class="col-date"><col class="col-time"><col class="col-type">
          <col class="col-actor"><col class="col-place"><col class="col-fact"><col class="col-evi"><col class="col-act">
        </colgroup>
        <thead><tr>
          <th>#</th><th>日付</th><th>時刻</th><th>種別</th><th>関与者</th><th>場所</th><th>内容（事実）</th><th>証拠</th><th>操作</th>
        </tr></thead>
        <tbody id="listBody"><tr><td colspan="9" class="muted">まだ追加がありません</td></tr></tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <h2>出来事の追加</h2>
    <div class="grid">
      <div><label>発生日（開始）<input id="evDate" type="date" placeholder="yyyy/mm/dd"></label></div>
      <div><label>発生時刻（任意）<input id="evTime" type="time"></label></div>
      <div><label>種別
        <select id="evType">
          <option>連絡</option><option>支払い</option><option>通知</option><option>契約</option>
          <option>滞納</option><option>登記</option><option>DV</option><option>その他</option>
        </select></label></div>
      <div><label>関与者（誰が）<input id="evActor" placeholder="例：相手方／自分／子"></label></div>
      <div class="col2"><label>場所（任意）<input id="evPlace" placeholder="例：自宅／職場／LINE"></label></div>
      <div class="col3"><label>内容（事実ベース・140字まで）<textarea id="evFact" maxlength="140" style="height:100px"></textarea></label></div>
      <div><label>裏付け証拠（タイトルのみでも可）<input id="evEvidence" placeholder="例：スクショ（2025-05-10）"></label></div>

      <!-- 1行目：カウンタ & 追加 -->
      <div class="col4 toolbar" style="justify-content:space-between">
        <span id="counter" class="muted">0/140</span>
        <button id="addBtn" class="btn btn-plain">＋ この内容を追加</button>
      </div>
      <!-- 2行目：未保存表示 & 手動保存（復元） -->
      <div class="col4 toolbar" style="justify-content:flex-end;gap:10px">
        <span id="unsaved" class="muted" style="display:none">● 未保存あり</span>
        <button id="saveNow" class="btn btn-primary">保存（この端末）</button>
      </div>
    </div>
    <div id="inlineError" class="muted" style="color:#b11;margin-top:6px;"></div>
  </div>
</div>

<div id="PRINT_SHEET"></div>

<!-- 編集ダイアログ -->
<dialog id="editDlg">
  <div style="padding:12px 16px;border-bottom:1px solid #eee;font-weight:700">編集</div>
  <div style="padding:14px 16px;min-width:420px">
    <div class="grid">
      <div><label>発生日<input id="edDate" type="date"></label></div>
      <div><label>時刻<input id="edTime" type="time"></label></div>
      <div><label>種別
        <select id="edType">
          <option>連絡</option><option>支払い</option><option>通知</option><option>契約</option>
          <option>滞納</option><option>登記</option><option>DV</option><option>その他</option>
        </select></label></div>
      <div><label>関与者<input id="edActor"></label></div>
      <div class="col2"><label>場所<input id="edPlace"></label></div>
      <div class="col3"><label>内容<textarea id="edFact" maxlength="140" style="height:100px"></textarea></label></div>
      <div><label>証拠<input id="edEvidence"></label></div>
    </div>
  </div>
  <div style="padding:10px 16px;border-top:1px solid #eee;display:flex;gap:8px;justify-content:flex-end">
    <button id="editSave" class="btn btn-primary">保存</button>
    <button id="editCancel" class="btn btn-plain">キャンセル</button>
  </div>
</dialog>

<!-- 案件ダイアログ -->
<dialog id="caseDlg">
  <div style="padding:12px 16px;border-bottom:1px solid #eee;font-weight:700" id="caseDlgTitle">案件</div>
  <div style="padding:14px 16px;min-width:360px">
    <label>案件名<input id="caseName"></label>
    <div id="caseError" class="muted" style="color:#b11;margin-top:6px;"></div>
  </div>
  <div style="padding:10px 16px;border-top:1px solid #eee;display:flex;gap:8px;justify-content:flex-end">
    <button id="caseOk" class="btn btn-primary">保存</button>
    <button id="caseCancel" class="btn btn-plain">キャンセル</button>
  </div>
</dialog>

<script>
(function(){
  "use strict";
  const $=id=>document.getElementById(id);
  const KEY_MAIN="KAWAI_TIMELINE_CASESAFE_V1"; // 既存データを引き継ぐ
  const MAX_CASES=500;
  const S={cases:{},order:[],current:""};
  let storeOK=false, DIRTY=false;

  // ローカル保存可否の診断（UI表示はしない）
  try{ localStorage.setItem("__t","1"); localStorage.removeItem("__t"); storeOK=true; }catch(e){ storeOK=false; }

  function today(){ return new Date().toISOString().slice(0,10); }
  function persist(){
    try{ if(storeOK) localStorage.setItem(KEY_MAIN, JSON.stringify(S)); }catch(e){}
    DIRTY=false; showUnsaved(false);
  }
  function showUnsaved(on){ const u=$("unsaved"); if(u) u.style.display = on ? "inline" : "none"; }
  function markDirty(){
    if($("autoSave").checked){ persist(); }
    else { DIRTY=true; showUnsaved(true); }
  }
  function loadMain(){
    try{
      const o=JSON.parse(localStorage.getItem(KEY_MAIN)||"null");
      if(o&&o.cases){ S.cases=o.cases; S.order=o.order||Object.keys(o.cases); S.current=(o.current&&o.cases[o.current])?o.current:(S.order[0]||""); return true; }
    }catch(e){} return false;
  }
  function ensureDefault(){ if(!S.order.length){ const n="案件A_"+today(); S.cases[n]=[]; S.order=[n]; S.current=n; persist(); } }
  function events(){ return S.cases[S.current]||(S.cases[S.current]=[]); }

  function uiCases(){
    const sel=$("caseSelect"); sel.innerHTML="";
    S.order.forEach(n=>{ const op=document.createElement("option"); op.value=n; op.textContent=n; if(n===S.current) op.selected=true; sel.appendChild(op); });
    render();
  }

  function render(){
    const tbody=$("listBody"); tbody.innerHTML="";
    const arr=events().slice().map((ev,idx)=>({ev,idx}))
      .sort((a,b)=>((a.ev.date||"")+(a.ev.time||"")).localeCompare((b.ev.date||"")+(b.ev.time||"")));
    if(!arr.length){
      const tr=document.createElement("tr"); const td=document.createElement("td");
      td.colSpan=9; td.className="muted"; td.textContent="まだ追加がありません";
      tr.appendChild(td); tbody.appendChild(tr); drawGrid(); return;
    }
    arr.forEach((item,i)=>{
      const e=item.ev;
      const tr=document.createElement("tr");
      function td(t,cls){ const x=document.createElement("td"); if(cls) x.className=cls; x.textContent=t||""; return x; }
      tr.append(td(i+1), td(e.date,"nowrap"), td(e.time,"nowrap"), td(e.type), td(e.actor), td(e.place), td(e.fact,"pre fact"), td(e.evidence));
      const tdAct=document.createElement("td"); tdAct.className="actions";
      const bE=document.createElement("button"); bE.textContent="編集"; bE.className="btn btn-plain";
      const bD=document.createElement("button"); bD.textContent="削除"; bD.className="btn btn-warn";
      bE.onclick=()=>openEdit(item.idx);
      bD.onclick=()=>{ if(confirm("この行を削除します。よろしいですか？")){ events().splice(item.idx,1); markDirty(); render(); } };
      tdAct.append(bE,bD); tr.appendChild(tdAct);
      tbody.appendChild(tr);
    });
    drawGrid();
  }

  // —— 画面用：SVGグリッド（縦横）
  function getColumnXs(table){
    const th = table.tHead && table.tHead.rows[0];
    if(!th) return [];
    const cells = Array.from(th.cells).filter(c=>c.offsetWidth>0 && getComputedStyle(c).display!=="none");
    const xs=[0]; let running=0;
    cells.forEach(c=>{ running += c.offsetWidth; xs.push(running); });
    return xs;
  }
  function getRowYs(table){
    const rectT = table.getBoundingClientRect();
    const ys=[0];
    if(table.tHead){
      for(const tr of table.tHead.rows){
        ys.push(Math.round(tr.getBoundingClientRect().bottom - rectT.top));
      }
    }
    if(table.tBodies && table.tBodies.length){
      for(const tr of table.tBodies[0].rows){
        ys.push(Math.round(tr.getBoundingClientRect().bottom - rectT.top));
      }
    }
    ys.sort((a,b)=>a-b);
    const uniq=[]; for(const y of ys){ if(!uniq.length || Math.abs(y-uniq[uniq.length-1])>1) uniq.push(y); }
    return uniq;
  }
  function drawGrid(targetWrap){
    const wrap = targetWrap || document.getElementById("tableWrap");
    if(!wrap) return;
    const table = wrap.querySelector("table");
    const svg = wrap.querySelector(".gridlayer svg");
    if(!table || !svg) return;
    svg.innerHTML="";

    const stroke = getComputedStyle(document.documentElement).getPropertyValue("--grid-color")?.trim() || "#000";
    const sw = parseFloat(getComputedStyle(document.documentElement).getPropertyValue("--grid-w")) || 1;
    const W = Math.round(table.offsetWidth), H = Math.round(table.offsetHeight);
    svg.setAttribute("viewBox", `0 0 ${W} ${H}`);
    svg.setAttribute("preserveAspectRatio","none");

    const xs = getColumnXs(table);
    const ys = getRowYs(table);

    // 外枠
    const rect = document.createElementNS("http://www.w3.org/2000/svg","rect");
    rect.setAttribute("x", 0.5); rect.setAttribute("y", 0.5);
    rect.setAttribute("width", Math.max(0, W-1)); rect.setAttribute("height", Math.max(0, H-1));
    rect.setAttribute("fill","none"); rect.setAttribute("stroke", stroke); rect.setAttribute("stroke-width", sw);
    rect.setAttribute("vector-effect","non-scaling-stroke");
    svg.appendChild(rect);

    // 縦線
    xs.forEach((x,i)=>{
      if(i===0 || i===xs.length-1) return;
      const line = document.createElementNS("http://www.w3.org/2000/svg","line");
      const cx = Math.round(x)+0.5;
      line.setAttribute("x1", cx); line.setAttribute("y1", 0);
      line.setAttribute("x2", cx); line.setAttribute("y2", H);
      line.setAttribute("stroke", stroke); line.setAttribute("stroke-width", sw);
      line.setAttribute("vector-effect","non-scaling-stroke");
      svg.appendChild(line);
    });

    // 横線
    ys.forEach((y,i)=>{
      if(i===0 || i===ys.length-1) return;
      const line = document.createElementNS("http://www.w3.org/2000/svg","line");
      const cy = Math.round(y)+0.5;
      line.setAttribute("x1", 0); line.setAttribute("y1", cy);
      line.setAttribute("x2", W); line.setAttribute("y2", cy);
      line.setAttribute("stroke", stroke); line.setAttribute("stroke-width", sw);
      line.setAttribute("vector-effect","non-scaling-stroke");
      svg.appendChild(line);
    });
  }
  window.addEventListener("resize", ()=>drawGrid());
  const mo = new MutationObserver(()=>drawGrid());
  mo.observe(document.getElementById("listBody"), {childList:true,subtree:true});

  // —— 編集ダイアログ
  let editingIndex=-1; const dlg=$("editDlg");
  function openEdit(i){ editingIndex=i; const ev=events()[i]; if(!ev) return;
    $("edDate").value=ev.date||""; $("edTime").value=ev.time||""; $("edType").value=ev.type||"その他";
    $("edActor").value=ev.actor||""; $("edPlace").value=ev.place||""; $("edFact").value=ev.fact||""; $("edEvidence").value=ev.evidence||"";
    if(dlg.showModal) dlg.showModal(); else alert("このブラウザはダイアログに未対応です。");
  }
  $("editCancel").onclick=()=>dlg.close && dlg.close();
  $("editSave").onclick=()=>{
    const i=editingIndex; if(i<0){ dlg.close && dlg.close(); return; }
    const nv={date:$("edDate").value||"", time:$("edTime").value||"", type:$("edType").value||"", actor:($("edActor").value||"").trim(), place:($("edPlace").value||"").trim(), fact:($("edFact").value||"").trim(), evidence:($("edEvidence").value||"").trim()};
    if(!nv.date||!nv.fact){ alert("日付 と 内容 は必須です"); return; }
    events()[i]=nv; markDirty(); render(); dlg.close && dlg.close();
  };

  // —— 案件操作（完成版どおり）
  const caseDlg = $("caseDlg"), caseName = $("caseName"), caseError = $("caseError");
  let caseMode="new";
  function openCaseDialog(mode){
    caseMode=mode;
    $("caseDlgTitle").textContent = (mode==="new")?"新規案件":"案件名の変更";
    caseName.value = (mode==="rename") ? (S.current||"") : "";
    caseError.textContent="";
    caseDlg.showModal();
  }
  $("caseCancel").onclick=()=>caseDlg.close();
  $("caseOk").onclick=()=>{
    const name = (caseName.value||"").trim();
    if(!name){ caseError.textContent="案件名を入力してください"; return; }
    if(caseMode==="new"){
      if(S.order.length>=MAX_CASES){ caseError.textContent="案件数が上限に達しました（MAX "+MAX_CASES+"）。"; return; }
      if(S.cases[name]){ caseError.textContent="同名の案件が既にあります"; return; }
      S.cases[name]=[]; S.order.push(name); S.current=name; persist(); uiCases(); caseDlg.close();
    }else{
      const cur=S.current; if(!cur){ caseDlg.close(); return; }
      if(name===cur){ caseDlg.close(); return; }
      if(S.cases[name]){ caseError.textContent="その名前は使用されています"; return; }
      S.cases[name]=S.cases[cur]; delete S.cases[cur];
      S.order=S.order.map(x=>x===cur?name:x); S.current=name; persist(); uiCases(); caseDlg.close();
    }
  };
  $("newCase").onclick=()=>openCaseDialog("new");
  $("renameCase").onclick=()=>openCaseDialog("rename");
  $("dupCase").onclick=()=>{
    const c=S.current; if(!c) return;
    let cand=c+"_複製", i=2; while(S.cases[cand]) cand=c+"_複製_"+(i++);
    S.cases[cand]=JSON.parse(JSON.stringify(S.cases[c]||[])); S.order.push(cand); S.current=cand; persist(); uiCases();
  };
  $("deleteCase").onclick=()=>{
    const c=S.current; if(!c) return;
    if(!confirm(`案件「${c}」を削除します。よろしいですか？`)) return;
    delete S.cases[c]; S.order=S.order.filter(x=>x!==c); S.current=S.order[0]||"";
    if(!S.current){ ensureDefault(); }
    persist(); uiCases();
  };
  $("caseSelect").addEventListener("change", (e)=>{
    S.current = e.target.value || S.current;
    persist(); render();
  });

  // 初期化
  (function init(){
    if(!loadMain()) ensureDefault();
    uiCases();
    $("evDate").value=today();
    $("counter").textContent="0/140";
    const savedAuto = localStorage.getItem("__autosave__")==="1";
    $("autoSave").checked = !!savedAuto;
    $("autoSave").addEventListener("change", ()=>{
      const on = $("autoSave").checked;
      localStorage.setItem("__autosave__", on ? "1" : "0");
      if(on && DIRTY){ persist(); }   // オンに切替時に未保存があれば即保存
    });
    // 未保存表示は初期非表示
    showUnsaved(false);
    // 離脱警告（未保存あり & オートセーブOFF時）
    window.addEventListener("beforeunload", e=>{
      if(!$("autoSave").checked && DIRTY){ e.preventDefault(); e.returnValue=""; }
    });
  })();

  // 入力
  $("evFact").addEventListener("input",()=>{ $("counter").textContent=($("evFact").value||"").length+"/140"; });
  $("addBtn").onclick=()=>{
    const e={
      date:$("evDate").value||"",
      time:$("evTime").value||"",
      type:$("evType").value||"",
      actor:($("evActor").value||"").trim(),
      place:($("evPlace").value||"").trim(),
      fact:($("evFact").value||"").trim(),
      evidence:($("evEvidence").value||"").trim()
    };
    if(!e.date||!e.fact){ $("inlineError").textContent="日付 と 内容 は必須です"; return; }
    $("inlineError").textContent="";
    events().push(e); markDirty(); render();
  };

  // 手動保存（この端末）
  $("saveNow").onclick=()=>{ persist(); alert("この端末のブラウザに保存しました。"); };

  // 端末の全データ削除
  $("wipeAll").onclick=()=>{
    if(confirm("この端末のブラウザに保存された全ての案件・データを削除します。よろしいですか？")){
      try{ localStorage.removeItem(KEY_MAIN); }catch(e){}
      location.reload();
    }
  };

  // —— 印刷（同一ページ方式・操作欄なし・ヘッダ青）
  $("printBtn").onclick=()=>{
    const host = $("PRINT_SHEET");
    host.innerHTML="";
    const sheet = buildPrintSheetNode(12);
    host.appendChild(sheet);
    setTimeout(()=>{
      try{ window.focus(); }catch(e){}
      window.print();
      const cleanup=()=>{ host.innerHTML=""; };
      window.addEventListener("afterprint", cleanup, {once:true});
      setTimeout(cleanup, 1500);
    }, 50);
  };

  function buildPrintSheetNode(fontPx){
    const headers=["#","日付","時刻","種別","関与者","場所","内容（事実）","証拠"];
    const widths=[4,12,6,6,9,9,48,6];
    const table=document.createElement("table");
    table.style.width="var(--print-table-width)"; table.style.borderCollapse="collapse"; table.style.tableLayout="fixed"; table.style.border="1px solid #000"; table.style.boxSizing="border-box";
    const thead=document.createElement("thead"); const trh=document.createElement("tr");
    const thBg = getComputedStyle(document.documentElement).getPropertyValue('--th') || '#eef2fb';
    headers.forEach((h,i)=>{
      const th=document.createElement("th");
      th.textContent=h;
      th.style.border="1px solid #000"; th.style.padding="6px"; th.style.fontSize=(fontPx||12)+"px";
      th.style.background=thBg.trim() || '#eef2fb'; th.style.color="#000";
      th.style.width=widths[i]+"%"; th.style.boxSizing="border-box";
      trh.appendChild(th);
    });
    thead.appendChild(trh); table.appendChild(thead);
    const tbody=document.createElement("tbody");
    const arr=events().slice().sort((a,b)=>((a.date||"")+(a.time||"")).localeCompare((b.date||"")+(b.time||"")));
    arr.forEach((e,i)=>{
      const tr=document.createElement("tr");
      const vals=[i+1,e.date||"",e.time||"",e.type||"",e.actor||"",e.place||"",e.fact||"",e.evidence||""];
      vals.forEach((v,idx)=>{
        const td=document.createElement("td");
        td.textContent=v;
        td.style.border="1px solid #000"; td.style.padding="6px"; td.style.fontSize=(fontPx||12)+"px"; td.style.boxSizing="border-box";
        if(idx===6) td.style.whiteSpace="pre-wrap";
        td.style.width=widths[idx]+"%";
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    const container=document.createElement("div");
    container.style.paddingRight = "var(--print-right-pad)";
    container.appendChild(table);
    return container;
  }
})();
</script>
</body>
</html>
