<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>相談準備用：時系列メモ（デスクトップ版｜送信しません）</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="法律相談の準備に使える時系列メモ（デスクトップ版）。入力は端末のブラウザにのみ保存され、外部へは送信されません。">
<meta name="referrer" content="no-referrer"><meta http-equiv="Referrer-Policy" content="no-referrer">
<meta name="robots" content="noindex, nofollow, noarchive">
<style>
/* ===== 基本配色・フォント ===== */
:root{ --bg:#f7f8fb; --b:#111; --m:#666; --bd:#dcdfea; --acc:#0a58cc;
       --th:#eef2fb; --td:#fff; --field:#cfd3e2; }
html,body{margin:0;padding:0;background:var(--bg);color:var(--b);
  font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP","Yu Gothic",Meiryo,sans-serif;}
#ktl-app{max-width:1100px;margin:16px auto 80px;padding:0 16px}
.ktl-card{background:#fff;border:1px solid var(--bd);border-radius:12px;padding:14px 16px;margin:12px 0;box-shadow:0 1px 0 rgba(10,10,20,.02)}
.ktl-muted{color:var(--m)}
.ktl-toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}

/* ラベル＋入力 */
#ktl-app label{display:block;margin:6px 0 4px;font-weight:600}
#ktl-app input[type="text"], #ktl-app input[type="date"], #ktl-app input[type="time"], #ktl-app select{
  width:100%; font-size:15px; line-height:1.35; padding:10px 12px; border:1px solid var(--field); border-radius:10px; background:#fff; color:#111;
}
#ktl-app textarea{
  width:100%; font-size:15px; line-height:1.5; padding:10px 12px; border:1px solid var(--field); border-radius:10px; background:#fff; min-height:120px; resize:vertical;
}

/* チェックと文言を横並び（従来仕様） */
.ktl-checkRow{ display:flex; align-items:center; gap:8px; margin:2px 0 0; }
.ktl-checkRow input[type="checkbox"]{ width:18px; height:18px; margin:0; }
.ktl-checkRow label{ margin:0; font-weight:700; }

/* ボタン */
.ktl-btn{padding:10px 14px;border:1px solid #333;border-radius:10px;background:#fff;cursor:pointer;font-size:14px;white-space:nowrap}
.ktl-btn-plain{border:1px solid #999}
.ktl-btn-warn{border-color:#b11;color:#b11}
.ktl-btn-primary{border-color:var(--acc);color:var(--acc);font-weight:700}

/* 2列グリッド */
.ktl-grid{display:grid;grid-template-columns:minmax(0,1fr) minmax(0,1fr);gap:12px}
.ktl-grid .ktl-col2{grid-column:1 / -1}

/* 案件行（横並び） */
.ktl-caseRow1{display:grid; grid-template-columns:auto 1fr; column-gap:12px; align-items:center;}
.ktl-caseRow1 > label{margin:0; font-weight:700; white-space:nowrap;}
.ktl-caseRow2{ gap:8px; margin-top:12px; }

/* セレクトの矢印（見た目統一） */
select{
  -webkit-appearance:none; appearance:none;
  background-image:url("data:image/svg+xml;utf8,\
<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23666'><path d='M7 10l5 5 5-5z'/></svg>");
  background-repeat:no-repeat; background-position:right 12px center; background-size:18px 18px; padding-right:42px;
}

/* ===== 一覧（画面用） ===== */
.ktl-tableWrap{position:relative;overflow-x:auto}
table.ktl-list{width:100%;border-collapse:collapse;table-layout:fixed;background:var(--td);margin:0}
table.ktl-list thead th{text-align:left;padding:8px 8px;font-weight:700;background:var(--th);border:0}
table.ktl-list tbody td{padding:8px 8px;vertical-align:top;border:0}
#ktl-app table.ktl-list th, #ktl-app table.ktl-list td{
  white-space:normal;word-break:break-word;overflow-wrap:anywhere;hyphens:auto;line-height:1.28; font-size:13px;
}
.ktl-list th:nth-child(1), .ktl-list td:nth-child(1){ text-align:center }
.ktl-nowrap{white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
.ktl-2lines{ display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }

/* 操作列（縦書き・小さめ）＝従来仕様 */
.ktl-actions{ display:flex; flex-direction:column; gap:6px; align-items:center; justify-content:center; }
.ktl-actions .ktl-btn{
  writing-mode: vertical-rl; text-orientation: upright;
  display:inline-flex; align-items:center; justify-content:center;
  min-height:56px; min-width:24px; padding:6px 2px; font-size:10px; line-height:1; letter-spacing:.06em; border-radius:10px;
}

/* 見出しとボタン群（従来配置） */
.ktl-cardHead{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:8px}

/* 印刷専用シート（初期は非表示） */
#PRINT_SHEET{ display:none; }

/* ====== 印刷スタイル（重複防止のみ・最小変更） ====== */
@media print{
  /* 画面側は完全に隠す → 二重印刷の根本原因を排除 */
  #ktl-app{ display:none !important; }
  /* 印刷用シートのみ表示 */
  #PRINT_SHEET{ display:block !important; }
  body{ background:#fff; }
  @page{ margin:14mm; }
  #PRINT_SHEET table{ width:100%; border-collapse:collapse; table-layout:fixed; font-size:12px; }
  #PRINT_SHEET th,#PRINT_SHEET td{ border:1px solid #000; padding:6px 6px; vertical-align:top; }
  #PRINT_SHEET th{ background:#e9f2ff; font-weight:700; }
  #PRINT_SHEET .pre{ white-space:pre-wrap; word-break:break-word; overflow-wrap:anywhere; }
}
</style>
</head>

<body>
<div id="ktl-app">

  <!-- 説明 -->
  <div class="ktl-card">
    <h1 style="margin:0 0 6px;font-size:20px">相談準備用・時系列メモ（送信されません）</h1>
    <div class="ktl-toolbar" style="gap:12px">
      <div class="ktl-checkRow">
        <input type="checkbox" id="autoSave">
        <label for="autoSave">変更のたびに自動保存</label>
      </div>
      <button id="wipeAll" class="ktl-btn ktl-btn-warn" style="margin-left:auto">全データ削除（この端末）</button>
    </div>
    <p class="ktl-muted" style="line-height:1.6;font-size:14px;margin-top:8px">
      入力は<strong>この端末のブラウザにのみ保存</strong>され、<strong>外部には送信されません</strong>。
    </p>
  </div>

  <!-- 案件 -->
  <div class="ktl-card">
    <div class="ktl-caseRow1">
      <label for="caseSelect">案件：</label>
      <div><select id="caseSelect"></select></div>
    </div>
    <div class="ktl-toolbar ktl-caseRow2">
      <button id="newCase" class="ktl-btn ktl-btn-plain">新規案件</button>
      <button id="renameCase" class="ktl-btn ktl-btn-plain">名前変更</button>
      <button id="dupCase"   class="ktl-btn ktl-btn-plain">複製</button>
      <button id="deleteCase" class="ktl-btn ktl-btn-warn">案件削除</button>
    </div>
  </div>

  <!-- 一覧 -->
  <div class="ktl-card">
    <div class="ktl-cardHead">
      <h2 style="margin:0;font-size:16px">時系列一覧</h2>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="printBtn" class="ktl-btn ktl-btn-primary">印刷（時系列一覧）</button>
      </div>
    </div>

    <div class="ktl-tableWrap">
      <table id="listTable" class="ktl-list">
        <colgroup>
          <!-- 従来の列幅に合わせています -->
          <col style="width:5%"><!-- # -->
          <col style="width:13%"><!-- 日付 -->
          <col style="width:10%"><!-- 時刻 -->
          <col style="width:12%"><!-- 種別 -->
          <col style="width:12%"><!-- 関与者 -->
          <col style="width:12%"><!-- 場所 -->
          <col style="width:24%"><!-- 内容 -->
          <col style="width:12%"><!-- 証拠 -->
          <col style="width:10%"><!-- 操作 -->
        </colgroup>
        <thead><tr>
          <th>#</th><th>日付</th><th>時刻</th><th>種別</th><th>関与者</th><th>場所</th><th>内容（事実）</th><th>証拠</th><th>操作</th>
        </tr></thead>
        <tbody id="listBody"><tr><td colspan="9" class="ktl-muted">まだ追加がありません</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- 追加フォーム -->
  <div class="ktl-card">
    <h2 style="font-size:16px;margin:0 0 6px">出来事の追加</h2>
    <div class="ktl-grid">
      <div><label>発生日<input id="evDate" type="date"></label></div>
      <div><label>発生時刻（任意）<input id="evTime" type="time"></label></div>
      <div><label>種別
        <select id="evType">
          <option>連絡</option><option>支払い</option><option>通知</option><option>契約</option>
          <option>滞納</option><option>登記</option><option>DV</option><option>その他</option>
        </select>
      </label></div>
      <div><label>関与者（誰が）<input id="evActor" placeholder="例：相手方／自分／子"></label></div>
      <div><label>場所（任意）<input id="evPlace" placeholder="例：自宅／職場／LINE"></label></div>
      <div class="ktl-col2"><label>内容（事実ベース）<textarea id="evFact"></textarea></label></div>
      <div class="ktl-col2"><label>裏付け証拠（タイトルでも可）<input id="evEvidence" placeholder="例：スクショ（2025-05-10）"></label></div>
      <div class="ktl-col2" style="display:flex;gap:8px;justify-content:flex-end;align-items:center">
        <button id="addBtn" class="ktl-btn ktl-btn-primary">＋ この内容を追加</button>
        <button id="saveNow" class="ktl-btn ktl-btn-primary">保存（この端末）</button>
        <span id="unsaved" class="ktl-muted" style="display:none;">● 未保存あり</span>
      </div>
    </div>
    <div id="inlineError" class="ktl-muted" style="color:#b11;margin-top:6px;"></div>
  </div>

</div>

<!-- 印刷用シート（@media print でのみ表示） -->
<div id="PRINT_SHEET"></div>

<!-- 編集ダイアログ（従来サイズ） -->
<dialog id="editDlg">
  <div style="padding:12px 14px;border-bottom:1px solid #eee;font-weight:700">編集</div>
  <div style="padding:14px 14px;min-width:420px">
    <div class="ktl-grid">
      <div><label>発生日<input id="edDate" type="date"></label></div>
      <div><label>時刻<input id="edTime" type="time"></label></div>
      <div><label>種別
        <select id="edType">
          <option>連絡</option><option>支払い</option><option>通知</option><option>契約</option>
          <option>滞納</option><option>登記</option><option>DV</option><option>その他</option>
        </select>
      </label></div>
      <div><label>関与者<input id="edActor"></label></div>
      <div><label>場所<input id="edPlace"></label></div>
      <div class="ktl-col2"><label>内容<textarea id="edFact" style="min-height:120px"></textarea></label></div>
      <div class="ktl-col2"><label>証拠<input id="edEvidence"></label></div>
    </div>
  </div>
  <div style="padding:10px 14px;border-top:1px solid #eee;display:flex;gap:8px;justify-content:flex-end">
    <button id="editSave" class="ktl-btn ktl-btn-primary">保存</button>
    <button id="editCancel" class="ktl-btn ktl-btn-plain">キャンセル</button>
  </div>
</dialog>

<script>
(function(){
  "use strict";
  const $=id=>document.getElementById(id);

  /* ====== 保存キー（従来）＋旧キーからの片道インポート ====== */
  const KEY_MAIN   = "KAWAI_TIMELINE_CASESAFE_DESKTOP_V1";   // ← 以前の完成版と同じ
  const KEY_BACKUP = KEY_MAIN + "_BACKUP";
  const LEGACY_KEYS = [
    "KAWAI_TIMELINE_CASESAFE_V1",                 // モバイル初期版など
    "KAWAI_TIMELINE_CASESAFE_DESKTOP_TEST_V1"     // テスト版
  ];

  const S={cases:{},order:[],current:"",meta:{updatedAt:Date.now()}};
  let storeOK=false, DIRTY=false;

  /* ====== util ====== */
  try{ localStorage.setItem("__t","1"); localStorage.removeItem("__t"); storeOK=true; }catch(e){ storeOK=false; }
  const safeParse=s=>{ try{return JSON.parse(s);}catch(_){return null;} };
  const today=()=> new Date().toISOString().slice(0,10);
  const val=(id)=>($(id).value||"").trim();
  const events=()=> S.cases[S.current]||(S.cases[S.current]=[]);

  function persist(){
    if(!storeOK) return;
    try{
      const str=JSON.stringify(S);
      localStorage.setItem(KEY_MAIN,str);
      localStorage.setItem(KEY_BACKUP,str);
      DIRTY=false; showUnsaved(false);
    }catch(e){}
  }

  function loadFrom(str){
    const o=safeParse(str); if(!o||!o.cases) return false;
    S.cases=o.cases; S.order=o.order||Object.keys(o.cases); S.current=o.current&&o.cases[o.current]?o.current:(S.order[0]||"");
    S.meta=o.meta||{updatedAt:Date.now()}; return true;
  }

  function load(){
    if(!storeOK) return false;
    const main = localStorage.getItem(KEY_MAIN) || localStorage.getItem(KEY_BACKUP);
    if(main && loadFrom(main)) return true;
    // 旧キーからの片道インポート（見つかったら現キーへ保存）
    for(const k of LEGACY_KEYS){
      const v = localStorage.getItem(k);
      if(v && loadFrom(v)){ persist(); return true; }
    }
    return false;
  }

  function ensureDefault(){
    if(!S.order.length){ const n="案件A_"+today(); S.cases[n]=[]; S.order=[n]; S.current=n; }
  }
  function fillCaseSelect(){
    const sel=$("caseSelect"); sel.innerHTML="";
    S.order.forEach(n=>{ const op=document.createElement("option"); op.value=n; op.textContent=n; if(n===S.current) op.selected=true; sel.appendChild(op); });
  }

  /* ===== 画面描画（従来のまま） ===== */
  function cellText(t,cls){ const td=document.createElement("td"); if(cls) td.className=cls; td.textContent=t||""; return td; }
  function cell2lines(t){ const td=document.createElement("td"); const sp=document.createElement("span"); sp.className="ktl-2lines"; sp.textContent=t||""; td.appendChild(sp); return td; }

  function render(){
    const tbody=$("listBody"); tbody.innerHTML="";
    const arr=events().slice().map((ev,idx)=>({ev,idx}))
      .sort((a,b)=>((a.ev.date||"")+(a.ev.time||"")).localeCompare((b.ev.date||"")+(b.ev.time||"")));
    if(!arr.length){
      const tr=document.createElement("tr"); const td=document.createElement("td"); td.colSpan=9; td.className="ktl-muted"; td.textContent="まだ追加がありません"; tr.appendChild(td); tbody.appendChild(tr); return;
    }
    arr.forEach((item,i)=>{
      const e=item.ev; const tr=document.createElement("tr");
      tr.append(
        cellText(i+1),
        cell2lines(e.date),
        cellText(e.time,"ktl-nowrap"),
        cellText(e.type),
        cellText(e.actor),
        cellText(e.place),
        cellText(e.fact),
        cellText(e.evidence)
      );
      const tdAct=document.createElement("td"); tdAct.className="ktl-actions";
      const bE=document.createElement("button"); bE.textContent="編集"; bE.className="ktl-btn ktl-btn-plain";
      const bD=document.createElement("button"); bD.textContent="削除"; bD.className="ktl-btn ktl-btn-warn";
      bE.onclick=()=>openEdit(item.idx);
      bD.onclick=()=>{ if(confirm("この行を削除します。よろしいですか？")){ events().splice(item.idx,1); markDirty(); render(); } };
      tdAct.append(bE,bD); tr.appendChild(tdAct);
      tbody.appendChild(tr);
    });
  }

  /* ===== 追加・編集 ===== */
  $("addBtn").onclick=()=>{
    const e={ date:val("evDate"), time:val("evTime"), type:val("evType"), actor:val("evActor"),
              place:val("evPlace"), fact:val("evFact"), evidence:val("evEvidence") };
    if(!e.date || !e.fact){ $("inlineError").textContent="日付 と 内容 は必須です"; return; }
    $("inlineError").textContent="";
    events().push(e); markDirty(); render();
  };
  let editingIndex=-1; const dlg=$("editDlg");
  function openEdit(i){ editingIndex=i; const ev=events()[i]; if(!ev) return;
    $("edDate").value=ev.date||""; $("edTime").value=ev.time||""; $("edType").value=ev.type||"その他";
    $("edActor").value=ev.actor||""; $("edPlace").value=ev.place||""; $("edFact").value=ev.fact||""; $("edEvidence").value=ev.evidence||"";
    dlg.showModal();
  }
  $("editCancel").onclick=()=>dlg.close();
  $("editSave").onclick=()=>{ const i=editingIndex; if(i<0){ dlg.close(); return; }
    const nv={ date:val("edDate"), time:val("edTime"), type:val("edType"), actor:val("edActor"),
               place:val("edPlace"), fact:val("edFact"), evidence:val("edEvidence") };
    if(!nv.date || !nv.fact){ alert("日付 と 内容 は必須です"); return; }
    events()[i]=nv; markDirty(); render(); dlg.close();
  };

  /* ===== 保存UI（従来） ===== */
  function showUnsaved(on){ $("unsaved").style.display=on?"inline":"none"; }
  function markDirty(){ if($("autoSave").checked){ persist(); }else{ DIRTY=true; showUnsaved(true); } }
  $("saveNow").onclick=()=>{ persist(); alert("この端末のブラウザに保存しました。"); };
  window.addEventListener("beforeunload", e=>{ if(!$("autoSave").checked && DIRTY){ e.preventDefault(); e.returnValue=""; } });

  /* ===== 案件操作（従来） ===== */
  $("caseSelect").addEventListener("change", e=>{ const v=e.target.value; if(S.cases[v]){ S.current=v; persist(); render(); } });
  $("newCase").onclick=()=>{ const n=prompt("新規案件名を入力してください","案件B_"+today()); if(!n) return; if(S.cases[n]){ alert("同名の案件があります"); return; } S.cases[n]=[]; S.order.push(n); S.current=n; markDirty(); fillCaseSelect(); render(); };
  $("renameCase").onclick=()=>{ const cur=S.current; if(!cur) return; const n=prompt("案件名を変更",cur); if(!n||n===cur) return; if(S.cases[n]){ alert("同名の案件があります"); return; } S.cases[n]=S.cases[cur]; delete S.cases[cur]; S.order=S.order.map(x=>x===cur?n:x); S.current=n; markDirty(); fillCaseSelect(); render(); };
  $("dupCase").onclick=()=>{ const cur=S.current; if(!cur) return; const n=prompt("複製後の案件名",cur+"_複製"); if(!n) return; if(S.cases[n]){ alert("同名の案件があります"); return; } S.cases[n]=JSON.parse(JSON.stringify(S.cases[cur]||[])); S.order.push(n); S.current=n; markDirty(); fillCaseSelect(); render(); };
  $("deleteCase").onclick=()=>{ const cur=S.current; if(!cur) return; if(!confirm("案件ごと削除します。よろしいですか？")) return; delete S.cases[cur]; S.order=S.order.filter(x=>x!==cur); S.current=S.order[0]||""; ensureDefault(); markDirty(); fillCaseSelect(); render(); };

  $("wipeAll").onclick=()=>{ if(!confirm("この端末に保存された全案件・全入力を完全に削除します。よろしいですか？")) return;
    try{ localStorage.removeItem(KEY_MAIN); localStorage.removeItem(KEY_BACKUP); }catch(e){}
    S.cases={}; S.order=[]; S.current=""; ensureDefault(); persist(); fillCaseSelect(); render();
    alert("この端末の保存データを削除しました。");
  };

  /* ===== 印刷（重複防止：@media print で画面非表示、印刷用だけ生成） ===== */
  $("printBtn").onclick=()=>{
    const ps=$("PRINT_SHEET"); ps.innerHTML="";
    const list=events().slice().sort((a,b)=>((a.date||"")+(a.time||"")).localeCompare((b.date||"")+(b.time||"")));
    if(!list.length){ alert("印刷できる行がありません。"); return; }

    const wrap=document.createElement("div");
    wrap.innerHTML = `
      <div style="margin:0 0 8px 0">
        <div style="font-weight:700;font-size:16px">時系列一覧</div>
        <div style="font-size:12px;color:#333">案件：<span id="p-case"></span>　作成：${new Date().toLocaleString()}</div>
      </div>`;
    wrap.querySelector("#p-case").textContent = S.current || "";

    const table=document.createElement("table");
    const thead=document.createElement("thead");
    thead.innerHTML = `<tr>
      <th style="width:5%">#</th><th style="width:13%">日付</th><th style="width:10%">時刻</th>
      <th style="width:12%">種別</th><th style="width:12%">関与者</th><th style="width:12%">場所</th>
      <th style="width:24%">内容（事実）</th><th style="width:12%">証拠</th>
    </tr>`;
    table.appendChild(thead);

    const tbody=document.createElement("tbody");
    list.forEach((e,i)=>{
      const tr=document.createElement("tr");
      const td=(t,cls)=>{ const d=document.createElement("td"); if(cls) d.className=cls; d.textContent=t||""; return d; };
      const tdPre=(t)=>{ const d=document.createElement("td"); d.className="pre"; d.textContent=t||""; return d; };
      tr.append(
        td(String(i+1)), td(e.date||""), td(e.time||""), td(e.type||""),
        td(e.actor||""), td(e.place||""), tdPre(e.fact||""), td(e.evidence||"")
      );
      tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    wrap.appendChild(table);
    ps.appendChild(wrap);

    window.print();
  };

  /* ===== 初期化（従来） ===== */
  (function init(){
    if(!load()) ensureDefault();
    fillCaseSelect(); render();
    $("evDate").value=today();
    $("autoSave").checked = (localStorage.getItem("__autosave__") === "1");
    $("autoSave").addEventListener("change",()=>localStorage.setItem("__autosave__", $("autoSave").checked?"1":"0"));
  })();

  /* ===== 軽いエラー表示（従来） ===== */
  window.addEventListener("error", e=>{
    if(!e || e.message==="Script error." || !e.error) return;
    const el=$("inlineError"); if(el){ el.textContent="エラー: " + (e.error?.message || e.message); el.style.display="block"; }
  });
  window.addEventListener("unhandledrejection", e=>{
    if(!e || !e.reason) return;
    const m = typeof e.reason==="string" ? e.reason : (e.reason.message || "");
    if(m){ const el=$("inlineError"); if(el){ el.textContent="エラー: " + m; el.style.display="block"; } }
  });
})();
</script>
</body>
</html>
